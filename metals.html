<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.18.1: http://docutils.sourceforge.net/" name="generator"/>

    <title>Metals in air masses and their effect on KD onset â€” KD and metal rich aerosols</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet"/>
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet"/>

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>
<link as="font" crossorigin="" href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" rel="preload" type="font/woff2"/>

    <link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" rel="stylesheet" type="text/css"/>
    <link href="_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
    <link href="_static/custom.css" rel="stylesheet" type="text/css"/>
    <link href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" rel="stylesheet" type="text/css"/>
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" rel="preload"/>
<link as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" rel="preload"/>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "https://github.com/AlFontal/kd-metals-swc");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-DC18W62KP8"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-DC18W62KP8');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'metals';</script>
    <link href="https://alfontal.github.io/kd-metals-swc/metals.html" rel="canonical"/>
    <link href="_static/favicon.ico" rel="shortcut icon"/>
    <link href="genindex.html" rel="index" title="Index"/>
    <link href="search.html" rel="search" title="Search"/>
    <link href="weekly-cycle-figures-ang.html" rel="next" title="Sub-weekly cycle Figures"/>
    <link href="hysplit_trajectories.html" rel="prev" title="Modelling the air sources with HYSPLIT"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <meta content="en" name="docsearch:language"/>
  </head>
  
  
  <body data-bs-root-margin="0px 0px -60%" data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-default-mode="" data-offset="180">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input class="sidebar-toggle" id="__primary" name="__primary" type="checkbox"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input class="sidebar-toggle" id="__secondary" name="__secondary" type="checkbox"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input aria-label="Search this book..." autocapitalize="off" autocomplete="off" autocorrect="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." spellcheck="false" type="search"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
    
    
      
    
    
    <img alt="Logo image" class="logo__image only-light" src="_static/logo.png"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    Sub-weekly signatures relate ultrafine aerosols enriched in metals from intensive farming and urban pollution to Kawasaki disease
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="hysplit_trajectories.html">HYSPLIT backtrajectories</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Chemistry and KD synchrony</a></li>
<li class="toctree-l1"><a class="reference internal" href="weekly-cycle-figures-ang.html">Sub-weekly Cycle Figures</a></li>
<li class="toctree-l1"><a class="reference internal" href="winds.html">North-Westerly Winds computation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main class="bd-main" id="main-content">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__primary" title="Toggle primary sidebar">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button aria-expanded="false" aria-label="Source repositories" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a class="btn btn-sm btn-source-repository-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/AlFontal/kd-metals-swc" target="_blank" title="Source repository">
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a class="btn btn-sm btn-source-issues-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="https://github.com/AlFontal/kd-metals-swc/issues/new?title=Issue%20on%20page%20%2Fmetals.html&amp;body=Your%20issue%20content%20here." target="_blank" title="Open an issue">
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button aria-expanded="false" aria-label="Download this page" class="btn dropdown-toggle" data-bs-toggle="dropdown" type="button">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a class="btn btn-sm btn-download-source-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" href="_sources/metals.ipynb" target="_blank" title="Download source file">
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button class="btn btn-sm btn-download-pdf-button dropdown-item" data-bs-placement="left" data-bs-toggle="tooltip" onclick="window.print()" title="Print to PDF">
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button class="btn btn-sm btn-fullscreen-button" data-bs-placement="bottom" data-bs-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" data-bs-placement="bottom" data-bs-toggle="tooltip" for="__secondary" title="Toggle secondary sidebar">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div class="onlyprint" id="jb-print-docs-body">
    <h1>Metals in air masses and their effect on KD onset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#python">Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#r">R</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-sets">Pre-sets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading">Reading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning">Cleaning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-view">Preliminary view</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-correlations">Pairwise correlations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering">Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-regression">Poisson Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapped-ci">Bootstrapped CI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#treating-concentration-as-a-categorical-variable">Treating concentration as a categorical variable</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#with-3-categories">With 3 categories</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#test-for-3-categories">Test for 3 categories</a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="metals-in-air-masses-and-their-effect-on-kd-onset">
<h1>Metals in air masses and their effect on KD onset<a class="headerlink" href="#metals-in-air-masses-and-their-effect-on-kd-onset" title="Permalink to this heading">#</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#preamble" id="id1">Preamble</a></p>
<ul>
<li><p><a class="reference internal" href="#imports" id="id2">Imports</a></p></li>
<li><p><a class="reference internal" href="#pre-sets" id="id3">Pre-sets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-preprocessing" id="id4">Data Preprocessing</a></p></li>
<li><p><a class="reference internal" href="#reading" id="id5">Reading</a></p>
<ul>
<li><p><a class="reference internal" href="#cleaning" id="id6">Cleaning</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#analysis" id="id7">Analysis</a></p>
<ul>
<li><p><a class="reference internal" href="#preliminary-view" id="id8">Preliminary view</a></p></li>
<li><p><a class="reference internal" href="#pairwise-correlations" id="id9">Pairwise correlations</a></p></li>
<li><p><a class="reference internal" href="#clustering" id="id10">Clustering</a></p></li>
<li><p><a class="reference internal" href="#poisson-regression" id="id11">Poisson Regression</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="preamble">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Preamble</a><a class="headerlink" href="#preamble" title="Permalink to this heading">#</a></h2>
<section id="imports">
<h3><a class="toc-backref" href="#id2" role="doc-backlink">Imports</a><a class="headerlink" href="#imports" title="Permalink to this heading">#</a></h3>
<section id="python">
<h4>Python<a class="headerlink" href="#python" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">load_ext</span> rpy2.ipython
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">dabest</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">plotnine</span> <span class="k">as</span> <span class="nn">p9</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">spearmanr</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">mizani.breaks</span> <span class="kn">import</span> <span class="n">date_breaks</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">mizani.formatters</span> <span class="kn">import</span> <span class="n">date_format</span><span class="p">,</span> <span class="n">percent_format</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multicomp</span> <span class="kn">import</span> <span class="n">pairwise_tukeyhsd</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">dendrogram</span><span class="p">,</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">fcluster</span>
<span class="kn">from</span> <span class="nn">matplotlib_inline.backend_inline</span> <span class="kn">import</span> <span class="n">set_matplotlib_formats</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="r">
<h4>R<a class="headerlink" href="#r" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">R</span>
library(dplyr)
library(ggplot2)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>R[write to console]: 
Attaching package: â€˜dplyrâ€™


R[write to console]: The following objects are masked from â€˜package:statsâ€™:

    filter, lag


R[write to console]: The following objects are masked from â€˜package:baseâ€™:

    intersect, setdiff, setequal, union
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pre-sets">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Pre-sets</a><a class="headerlink" href="#pre-sets" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set_matplotlib_formats</span><span class="p">(</span><span class="s1">'retina'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">'svg.fonttype'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'none'</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'dpi'</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
<span class="n">p9</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'figure_size'</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">p9</span><span class="o">.</span><span class="n">theme_set</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">theme_bw</span><span class="p">()</span> 
           <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
                      <span class="n">axis_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="data-preprocessing">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Data Preprocessing</a><a class="headerlink" href="#data-preprocessing" title="Permalink to this heading">#</a></h2>
</section>
<section id="reading">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Reading</a><a class="headerlink" href="#reading" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_chem_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">'../data/KD_chemistry_2011.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'openpyxl'</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_df</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">'../data/KD_chemistry_2011.xlsx'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'openpyxl'</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
         <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">72</span><span class="p">:</span><span class="mi">80</span><span class="p">]</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="cleaning">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Cleaning</a><a class="headerlink" href="#cleaning" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long_chemistry</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_chem_df</span>
                 <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">71</span><span class="p">,</span> <span class="p">:</span><span class="mi">38</span><span class="p">]</span>
                 <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Filter'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">T</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="s1">'ng/m3'</span><span class="p">])</span>
                 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">'concentration'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
                 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">compound</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'compound'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
                 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long_chemistry</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>compound</th>
      <th>concentration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011-03-22</td>
      <td>PM10</td>
      <td>39.650350</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-03-23</td>
      <td>PM10</td>
      <td>22.937063</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-03-24</td>
      <td>PM10</td>
      <td>36.391416</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-03-25</td>
      <td>PM10</td>
      <td>27.501910</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-03-26</td>
      <td>PM10</td>
      <td>28.251748</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_chemistry</span> <span class="o">=</span> <span class="n">long_chemistry</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'concentration'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kd_ts</span> <span class="o">=</span> <span class="p">(</span><span class="n">kd_df</span>
         <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Filter'</span><span class="p">)</span>
         <span class="o">.</span><span class="n">T</span>
         <span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
         <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">'KD cases D</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">:</span> <span class="sa">f</span><span class="s1">'kd_lag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)})</span>
         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'KD cases D03'</span><span class="p">:</span> <span class="s1">'kd_rolling_4'</span><span class="p">})</span>
         <span class="p">[[</span><span class="s1">'date'</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'kd_lag_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'kd_rolling_4'</span><span class="p">]]</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">kd_rolling_4</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">kd_rolling_4</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="analysis">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Analysis</a><a class="headerlink" href="#analysis" title="Permalink to this heading">#</a></h2>
<section id="preliminary-view">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Preliminary view</a><a class="headerlink" href="#preliminary-view" title="Permalink to this heading">#</a></h3>
<p>Just visualizing the change in KD cases (on a 4 day rolling window from 0 to +3 days), the aggregated concentration of all metals, and the concentration of PM10 we can already see the high degree of synchrony between these three variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">long_chemistry</span>
 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"compound=='METALLS'"</span><span class="p">)</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'concentration'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">after_stat</span><span class="p">(</span><span class="s1">'width * density'</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">binwidth</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">350</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">percent_format</span><span class="p">())</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                   <span class="n">axis_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">),</span>
                   <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Heavy Metals concentration (ng/mÂ³)'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Frequency'</span><span class="p">)</span>
 <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/8407e7da3418342c14f372a83798d7aba9d80bb5e6741b875e4b779356ba8ec7.png" src="_images/8407e7da3418342c14f372a83798d7aba9d80bb5e6741b875e4b779356ba8ec7.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">long_chemistry</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="s1">'PM10'</span><span class="p">,</span> <span class="s1">'METALLS'</span><span class="p">])]</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">==</span><span class="s1">'METALLS'</span><span class="p">,</span><span class="s1">'Metals [ng/mÂ³]'</span><span class="p">,</span> <span class="s1">'PM$_</span><span class="si">{10}</span><span class="s1">$ [Âµg/mÂ³]'</span><span class="p">))</span>
 <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">[[</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">]]</span>
         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'KD cases (4 day rolling window)'</span><span class="p">)</span>
         <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">'kd_rolling_4'</span><span class="p">:</span> <span class="s1">'concentration'</span><span class="p">}))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'concentration'</span><span class="p">)</span>
         <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span> 
         <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'group'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">)</span>
         <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
         <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
         <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 week'</span><span class="p">))</span>
      <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/06c2d0ac1cc61d73c3b4439dc544a472cdf2ce2a4c9009ef34b6a96cfe033ede.png" src="_images/06c2d0ac1cc61d73c3b4439dc544a472cdf2ce2a4c9009ef34b6a96cfe033ede.png"/>

</div>
</div>
</section>
<section id="pairwise-correlations">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Pairwise correlations</a><a class="headerlink" href="#pairwise-correlations" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">long_metals</span> <span class="o">=</span> <span class="p">(</span><span class="n">raw_chem_df</span>
               <span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">70</span><span class="p">,</span> <span class="p">:</span><span class="mi">38</span><span class="p">]</span>
               <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'Filter'</span><span class="p">)</span>
               <span class="o">.</span><span class="n">T</span>
               <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">'index'</span><span class="p">],</span> <span class="n">dayfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
               <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>
               <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">'concentration'</span><span class="p">)</span>
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
               <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">compound</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'compound'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wide_metals</span> <span class="o">=</span> <span class="n">long_metals</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">'concentration'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pairwise_corrs</span> <span class="o">=</span> <span class="p">(</span><span class="n">wide_metals</span>
                 <span class="o">.</span><span class="n">corr</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">'compound_b'</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">'r'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound</span> <span class="o">&lt;=</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound_b</span><span class="p">]</span>
                 <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">pairwise_corrs</span>
<span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'compound'</span><span class="p">]</span><span class="o">!=</span><span class="n">dd</span><span class="p">[</span><span class="s1">'compound_b'</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'compound'</span><span class="p">,</span> <span class="s1">'compound_b'</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_tile</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="s1">'r'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_classic</span><span class="p">()</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_continuous</span><span class="p">(</span><span class="s1">'RdBu_r'</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">"Pearson's $r$"</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_text</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="mf">49.5</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dd</span><span class="p">[[</span><span class="s1">'compound'</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(),</span>
                      <span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'top'</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_text</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">'compound_b + "   "'</span><span class="p">),</span> <span class="n">data</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">==</span><span class="s1">'As'</span><span class="p">],</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'right'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_discrete</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_discrete</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">),</span>
                  <span class="n">axis_line</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span>
                  <span class="n">axis_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span>
                  <span class="n">axis_ticks</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span>
                  <span class="n">legend_position</span><span class="o">=</span><span class="p">(</span><span class="mf">.65</span><span class="p">,</span> <span class="mf">.35</span><span class="p">),</span> <span class="n">legend_key_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                  <span class="n">legend_direction</span><span class="o">=</span><span class="s1">'vertical'</span><span class="p">,</span>
                  <span class="n">legend_text</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">),</span>
                  <span class="n">legend_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">'center'</span><span class="p">),</span>
                  <span class="p">)</span>

      <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/88a172eb9b046dcc7386b9dc51f366be55cef955c12962f4efaf91688167ed9a.png" src="_images/88a172eb9b046dcc7386b9dc51f366be55cef955c12962f4efaf91688167ed9a.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">spearman_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">spearmanr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">correlation</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># min-max scale the wide metals matrix:</span>
<span class="n">wide_metals_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wide_metals</span>
                        <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="p">(</span><span class="n">dd</span> <span class="o">-</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">dd</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span>
                        <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%b </span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
    <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
                        <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/corrmatrix.pdf'</span><span class="p">,</span>  <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The pairwise correlations plot showcases how multicolinear this dataset, with most compounds following a similar pattern among the 37 samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dendrogramcorrmatrix</span> <span class="o">=</span> <span class="n">wide_metals</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">linkage_matrix</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">wide_metals</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">'single'</span><span class="p">,</span> <span class="s1">'correlation'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="n">wide_metals</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="clustering">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Clustering</a><a class="headerlink" href="#clustering" title="Permalink to this heading">#</a></h3>
<p>Given the highly colinear dataset we have in hand, it makes no sense to try and separe the signal of most of these metals from each other. What I am going to do is performe agglomerative hierarchical clustering using 1 - correlation across each of these metals and generate groups that covariate across the samples in a similar manner:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">'seaborn-white'</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">125</span><span class="p">)</span>
<span class="n">dendrogram</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">color_threshold</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Distance (1 - Pearson's R)"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/dendrogram.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/4a28554ca5fdc30a2d3adde8c731a9e2c0ff3ff8c21672795bab5e91f21d1fe2.png" src="_images/4a28554ca5fdc30a2d3adde8c731a9e2c0ff3ff8c21672795bab5e91f21d1fe2.png"/>
</div>
</div>
<p>If I set the threshold on a distance of 0.3 (or a Pearson correlation of &lt; 0.7â€¦) what we get is a huge group with many metals, a second cluster with <code class="docutils literal notranslate"><span class="pre">Ge</span></code> and <code class="docutils literal notranslate"><span class="pre">Ni</span></code> and several individual metals as sole leaves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">big_metals_cluster</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'As'</span><span class="p">,</span> <span class="s1">'Ba'</span><span class="p">,</span> <span class="s1">'Be'</span><span class="p">,</span> <span class="s1">'Bi'</span><span class="p">,</span> <span class="s1">'Cd'</span><span class="p">,</span> <span class="s1">'Ce'</span><span class="p">,</span> <span class="s1">'Co'</span><span class="p">,</span> <span class="s1">'Cs'</span><span class="p">,</span> <span class="s1">'Cu'</span><span class="p">,</span> <span class="s1">'Dy'</span><span class="p">,</span> <span class="s1">'Er'</span><span class="p">,</span> <span class="s1">'Eu'</span><span class="p">,</span>
                      <span class="s1">'Ga'</span><span class="p">,</span> <span class="s1">'Gd'</span><span class="p">,</span> <span class="s1">'Ho'</span><span class="p">,</span> <span class="s1">'La'</span><span class="p">,</span> <span class="s1">'Li'</span><span class="p">,</span> <span class="s1">'Lu'</span><span class="p">,</span> <span class="s1">'Mn'</span><span class="p">,</span> <span class="s1">'Nb'</span><span class="p">,</span> <span class="s1">'Nd'</span><span class="p">,</span> <span class="s1">'Pb'</span><span class="p">,</span> <span class="s1">'Pr'</span><span class="p">,</span> <span class="s1">'Rb'</span><span class="p">,</span> <span class="s1">'Se'</span><span class="p">,</span>
                      <span class="s1">'Sm'</span><span class="p">,</span> <span class="s1">'Sn'</span><span class="p">,</span> <span class="s1">'Sr'</span><span class="p">,</span> <span class="s1">'Tb'</span><span class="p">,</span> <span class="s1">'Th'</span><span class="p">,</span> <span class="s1">'Ti'</span><span class="p">,</span> <span class="s1">'Tl'</span><span class="p">,</span> <span class="s1">'Tm'</span><span class="p">,</span> <span class="s1">'U'</span><span class="p">,</span> <span class="s1">'V'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">,</span> <span class="s1">'Yb'</span><span class="p">,</span> <span class="s1">'Zn'</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">metals</span> <span class="o">=</span> <span class="n">wide_metals</span><span class="o">.</span><span class="n">columns</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">fcluster</span><span class="p">(</span><span class="n">linkage_matrix</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s1">'distance'</span><span class="p">)</span>
<span class="n">metal_clusters</span> <span class="o">=</span> <span class="p">{</span><span class="n">metal</span><span class="p">:</span> <span class="n">cluster</span> <span class="k">for</span> <span class="n">metal</span><span class="p">,</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">metals</span><span class="p">,</span> <span class="n">clusters</span><span class="p">)}</span>
<span class="n">cluster_metals</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">metal</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">metals</span><span class="p">):</span>
    <span class="n">cluster_metals</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">metal</span><span class="p">]</span>
    
<span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">metals</span> <span class="ow">in</span> <span class="n">cluster_metals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">metals</span><span class="si">}</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 1:
 ['As', 'Ba', 'Be', 'Bi', 'Cd', 'Ce', 'Co', 'Cs', 'Cu', 'Dy', 'Er', 'Eu', 'Ga', 'Gd', 'Ho', 'La', 'Li', 'Lu', 'Mn', 'Nb', 'Nd', 'Pb', 'Pr', 'Rb', 'Se', 'Sm', 'Sn', 'Sr', 'Tb', 'Th', 'Ti', 'Tl', 'Tm', 'U', 'V', 'Y', 'Yb', 'Zn']

Cluster 7:
 ['Cr']

Cluster 2:
 ['Ge', 'Ni']

Cluster 5:
 ['Hf']

Cluster 6:
 ['Mo']

Cluster 4:
 ['Sb']

Cluster 10:
 ['Sc']

Cluster 9:
 ['Ta']

Cluster 8:
 ['W']

Cluster 3:
 ['Zr']
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">color_maps</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">cluster</span><span class="p">,</span> <span class="n">metals</span> <span class="ow">in</span> <span class="n">cluster_metals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">metal</span> <span class="ow">in</span> <span class="n">metals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cluster</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">color_maps</span><span class="p">[</span><span class="n">metal</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'red'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_maps</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'black'</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">clustermap</span><span class="p">(</span><span class="n">wide_metals_scaled</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                   <span class="n">metric</span><span class="o">=</span><span class="s1">'correlation'</span><span class="p">,</span>
                   <span class="n">method</span><span class="o">=</span><span class="s1">'average'</span><span class="p">,</span>
                   <span class="n">row_cluster</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">col_cluster</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">cmap</span><span class="o">=</span><span class="s1">'inferno'</span><span class="p">,</span>
                   <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                   <span class="n">yticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">xticklabels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">cbar_pos</span><span class="o">=</span><span class="p">(</span><span class="mf">.35</span><span class="p">,</span> <span class="mf">.87</span><span class="p">,</span> <span class="mf">.4</span><span class="p">,</span> <span class="mf">.03</span><span class="p">),</span>
                   <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">'orientation'</span><span class="p">:</span> <span class="s1">'horizontal'</span><span class="p">}</span>
                  <span class="p">)</span>

<span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">ax_cbar</span><span class="o">.</span><span class="n">spines</span><span class="p">:</span>
    <span class="n">g</span><span class="o">.</span><span class="n">ax_cbar</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">spine</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">'black'</span><span class="p">)</span>
    <span class="n">g</span><span class="o">.</span><span class="n">ax_cbar</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">spine</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>

<span class="n">g</span><span class="o">.</span><span class="n">ax_cbar</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">ax_cbar</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Min-maxed Concentration'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">g</span><span class="o">.</span><span class="n">ax_heatmap</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/59c1f6eb57e36d86955cfc96414db1bd64090f7fe5bba6e63749d446b30f564e.png" src="_images/59c1f6eb57e36d86955cfc96414db1bd64090f7fe5bba6e63749d446b30f564e.png"/>
</div>
</div>
<p>The aggregated variation in concentration of each clusters looks as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">min_max_norm</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metals</span> <span class="o">=</span> <span class="p">(</span><span class="n">long_metals</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">'compound'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">concentration</span><span class="o">=</span><span class="n">min_max_norm</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">)))</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">metal_clusters</span><span class="p">))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">metals</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cluster_metals</span><span class="p">))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cluster_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="s1">'Cluster '</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">[</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">': '</span> 
         <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">metals</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">', '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">big_metals_cluster</span> <span class="k">else</span> <span class="s1">'38 metals'</span><span class="p">))</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_max_metals</span>
  <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'cluster_label'</span><span class="p">,</span> <span class="s1">'date'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'concentration'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'cluster_label=="Cluster A: 38 metals"'</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">min_max_metals</span><span class="p">,</span> <span class="n">mapping</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
       
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'cluster_label'</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s1">'fixed'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 weeks'</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%b-</span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_y_continuous</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">([</span><span class="s1">'black'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Min-maxed Mean Concentration'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/clusters_ts.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bed868788c6203a863a98310bcd7dd82974d3121c05afe1103b1d9eabee5abbe.png" src="_images/bed868788c6203a863a98310bcd7dd82974d3121c05afe1103b1d9eabee5abbe.png"/>
</div>
</div>
<p>And we can visualize the intra-cluster 1 variability in the following figure, with the shadowed lines representing the min-maxed concentration of each individual metal within the cluster, and the dark thick line representing the average value of all the metals in the claster at each sample:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">long_metals</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">metal_clusters</span><span class="p">))</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'compound'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">concentration</span><span class="o">=</span><span class="n">min_max_norm</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">)))</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'concentration'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">group</span><span class="o">=</span><span class="s1">'compound'</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.15</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">stat_summary</span><span class="p">(</span><span class="n">fun_y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="s1">'line'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 weeks'</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%b-</span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Min-Maxed Concentration'</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Metals Cluster A'</span><span class="p">))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/8d9b00d99bb5e525762637160692f904234dcf199ecbdca0981fa7c4f4b2e1ae.png" src="_images/8d9b00d99bb5e525762637160692f904234dcf199ecbdca0981fa7c4f4b2e1ae.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cluster_concentrations</span> <span class="o">=</span> \
<span class="p">(</span><span class="n">long_metals</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cluster</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">compound</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">metal_clusters</span><span class="p">))</span>
 <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'cluster'</span><span class="p">,</span> <span class="s1">'date'</span><span class="p">])</span>
 <span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
 <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="p">)</span>
<span class="p">(</span><span class="n">cluster_concentrations</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'concentration'</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">([</span><span class="s1">'"Metals Cluster " + cluster.astype(str)'</span><span class="p">],</span> <span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'3 weeks'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s1">'wspace'</span><span class="p">:</span> <span class="mf">0.175</span><span class="p">})</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Date'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'Concentration [ng/mÂ³]'</span><span class="p">)</span>
      <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fb2ee6d1584f11a08f59941faaa8c6d4603ba6d69eaab759ca472cde56eca745.png" src="_images/fb2ee6d1584f11a08f59941faaa8c6d4603ba6d69eaab759ca472cde56eca745.png"/>

</div>
</div>
</section>
<section id="poisson-regression">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">Poisson Regression</a><a class="headerlink" href="#poisson-regression" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">poisson_regression_df</span> <span class="o">=</span> <span class="n">cluster_concentrations</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">'cluster==1'</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">poisson_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="s1">'kd_rolling_4 ~ concentration'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">poisson_regression_df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 1.560838
         Iterations 5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">poisson_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Poisson Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>     <td>kd_rolling_4</td>   <th>  No. Observations:  </th>  <td>    37</td>  
</tr>
<tr>
  <th>Model:</th>                <td>Poisson</td>     <th>  Df Residuals:      </th>  <td>    35</td>  
</tr>
<tr>
  <th>Method:</th>                 <td>MLE</td>       <th>  Df Model:          </th>  <td>     1</td>  
</tr>
<tr>
  <th>Date:</th>            <td>Tue, 21 Mar 2023</td> <th>  Pseudo R-squ.:     </th>  <td>0.09547</td> 
</tr>
<tr>
  <th>Time:</th>                <td>09:49:17</td>     <th>  Log-Likelihood:    </th> <td> -57.751</td> 
</tr>
<tr>
  <th>converged:</th>             <td>True</td>       <th>  LL-Null:           </th> <td> -63.846</td> 
</tr>
<tr>
  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>  LLR p-value:       </th> <td>0.0004802</td>
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
        <td></td>           <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P&gt;|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>     <td>   -0.1577</td> <td>    0.328</td> <td>   -0.481</td> <td> 0.630</td> <td>   -0.800</td> <td>    0.485</td>
</tr>
<tr>
  <th>concentration</th> <td>    0.0048</td> <td>    0.001</td> <td>    3.495</td> <td> 0.000</td> <td>    0.002</td> <td>    0.007</td>
</tr>
</tbody></table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">poisson_model</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">kd_ts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">preds</span><span class="o">=</span><span class="n">preds</span><span class="p">)</span>
 <span class="p">[[</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">,</span> <span class="s1">'preds'</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'preds'</span><span class="p">:</span> <span class="s1">'Predicted cases'</span><span class="p">,</span>
           <span class="s1">'kd_rolling_4'</span><span class="p">:</span> <span class="s1">'True cases'</span><span class="p">})</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> 
       <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'Filter'</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">'Filter'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">([</span><span class="s1">'#D3894C'</span><span class="p">,</span> <span class="s1">'#435B97'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_linetype_manual</span><span class="p">([</span><span class="s1">'dashed'</span><span class="p">,</span> <span class="s1">'solid'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 weeks'</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%b-</span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'KD cases [+0-3 days]'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'2011-04-23'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">4.8</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="s1">'text'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'RÂ²=43.6%'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span>
                  <span class="n">legend_background</span><span class="o">=</span> <span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>

<span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/poisson_preds.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/bd7f86796dd8d877df0cd6bc5a25f6881d59a0e2310e5a2524dfafa9437af4fa.png" src="_images/bd7f86796dd8d877df0cd6bc5a25f6881d59a0e2310e5a2524dfafa9437af4fa.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">poisson_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">alpha</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">beta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">double_axis_fig_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
 <span class="p">[[</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'concentration'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'concentration'</span><span class="p">:</span> <span class="s1">'Aggregated Concentration of Cluster A metals [ng/mÂ³]'</span><span class="p">,</span>
           <span class="s1">'kd_rolling_4'</span><span class="p">:</span> <span class="s1">'KD cases +0-3 days'</span><span class="p">})</span>
                       <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">double_axis_fig_data</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s1">'free_y'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 weeks'</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%b-</span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
<span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/kd_vs_cluster_ts.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/fcf533c43ee2a85ff8000d0895fd418c9f1ae92ba2302ad3ad8efb806d8b026c.png" src="_images/fcf533c43ee2a85ff8000d0895fd418c9f1ae92ba2302ad3ad8efb806d8b026c.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">double_axis_fig_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">'variable'</span><span class="p">])</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>variable
Aggregated Concentration of Cluster A metals [ng/mÂ³]    340.933779
KD cases +0-3 days                                        5.000000
Name: value, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">double_axis_fig_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">double_axis_fig_data</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'Aggregated Concentration of Cluster A metals [ng/mÂ³]'</span><span class="p">:</span> <span class="s1">'cluster_a'</span><span class="p">,</span>
           <span class="s1">'KD cases +0-3 days'</span><span class="p">:</span> <span class="s1">'kd_cases'</span><span class="p">})</span>
 <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'variable'</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">)</span>        
 
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">double_axis_fig_data</span> <span class="o">=</span> <span class="n">double_axis_fig_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">R</span> -i double_axis_fig_data -w 2600 -h 1400 -r 600

coef &lt;- 340 / 5 + .005

f &lt;- ggplot(double_axis_fig_data) + 
    aes(date, kd_cases) +
    theme_bw() +
    labs(x='Date') +
    scale_y_continuous(name='KD cases +0-3 days',
                       sec.axis=sec_axis(trans=~.*coef, name='Cluster A metals [ng/mÂ³]')) + 
    geom_line(aes(y=cluster_a / coef), color='red', alpha=1, size=1) +
    geom_line(size=1) +
    theme(axis.title.y.right = element_text(color = 'red', size=11),
          axis.title.y.left = element_text(size=11),
          panel.grid=element_blank()) 
ggsave('../output/figures/metals_kd_shared.pdf', f, device=cairo_pdf)
f
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Saving 4.33 x 2.33 in image
</pre></div>
</div>

<img alt="_images/6ab55bfc529ea3a55d0ba46272b701b8d530ba3e401440147fe95b37a9f193b5.png" src="_images/6ab55bfc529ea3a55d0ba46272b701b8d530ba3e401440147fe95b37a9f193b5.png"/>
</div>
</div>
<section id="bootstrapped-ci">
<h4>Bootstrapped CI<a class="headerlink" href="#bootstrapped-ci" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coef_estimates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="p">[],</span> <span class="n">beta</span><span class="o">=</span><span class="p">[])</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">boot_df</span> <span class="o">=</span> <span class="n">poisson_regression_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
    <span class="n">poisson</span><span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="s1">'kd_rolling_4 ~ concentration'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">boot_df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">poisson</span><span class="o">.</span><span class="n">params</span>
    <span class="n">coef_estimates</span><span class="p">[</span><span class="s1">'alpha'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">coef_estimates</span><span class="p">[</span><span class="s1">'beta'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 1.591604
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579411
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.487927
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591058
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540046
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.471981
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.487098
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514569
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.633551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.549658
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.528297
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.518570
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527348
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.619786
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519210
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575588
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.648725
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.448689
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.587793
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507847
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.551914
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.448381
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.460887
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.674075
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.508768
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.442898
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.634038
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500694
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.559635
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533841
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.606933
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603540
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548504
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497659
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539159
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566813
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497912
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.543094
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.435873
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.605761
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.637083
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519581
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.613401
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601262
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501798
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.661456
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.457647
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570590
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.488716
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.486716
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.681026
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.487256
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.606692
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592296
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.587980
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575118
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590385
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553448
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.613262
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581358
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505129
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.560688
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515735
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577054
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585802
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585983
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.544818
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.529055
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575497
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.598938
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.573815
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.541745
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.479966
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.610613
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.599427
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.452256
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577308
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548591
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.428212
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.617316
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591708
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.511356
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.605099
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.643138
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586284
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550556
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566407
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.622798
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.443856
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.493113
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.452628
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579574
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.446842
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.535134
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593059
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547272
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507119
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.522647
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553462
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577349
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.510663
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523919
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.477768
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.542133
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.587612
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.627028
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590168
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507192
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585971
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.589870
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.563161
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.635853
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.453042
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.608311
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.542229
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.562876
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.529145
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497957
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582233
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.542614
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.599035
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.390522
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.499215
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500269
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.632727
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.525736
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540523
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.491905
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.662083
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.457727
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586868
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591931
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.516197
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533248
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.665652
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.565756
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.446944
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.580714
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.447292
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584365
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.616469
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.485437
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.494964
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.518282
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.671341
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.594340
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.458388
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.522181
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.644390
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592814
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572921
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583437
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550263
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.543691
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.632538
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.668464
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.607550
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.517494
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.620847
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611072
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.537034
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514292
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.534528
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.512299
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503380
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.616485
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.546144
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602947
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.457554
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.525914
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533324
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520611
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.650431
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611905
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567555
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497431
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.536998
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.482574
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.463817
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.614085
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.407240
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.524423
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.680033
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574755
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.636012
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.528933
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590052
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567447
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592238
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593789
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.614450
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.559975
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.653527
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601235
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.571030
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.483560
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.501526
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.647876
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581422
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526959
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.528636
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.512248
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.447633
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500247
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.643469
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.565654
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574336
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505857
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.522024
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.657260
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.483708
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.663639
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574380
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.530030
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.631322
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547206
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.430953
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.467268
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.434122
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548034
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.513314
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.466140
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592016
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531568
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601664
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.627925
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.468972
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547062
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.656069
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550041
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.502629
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503523
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.551797
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.511376
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.652900
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590809
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.649596
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.546702
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500669
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503170
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520542
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526961
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.549565
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601382
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.644335
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.634355
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.470524
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592982
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.495883
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.478809
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.606827
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558652
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.642814
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.408363
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.600494
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.512479
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.562917
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.516799
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.518959
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.477304
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.580708
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566204
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553328
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591904
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577677
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.537735
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503863
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.589434
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.493087
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.511900
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505746
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583205
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569813
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.620883
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592027
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.530813
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.560091
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615816
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.537733
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.471824
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540538
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.633367
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.684166
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569381
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.446475
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.529110
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.607429
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.413887
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.446682
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.568755
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.467337
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.580664
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.483924
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.554251
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570081
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520756
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.436433
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.625790
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531836
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584513
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.423864
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.482787
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566369
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.428720
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593223
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553088
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.492535
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.502418
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.477141
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611072
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.555806
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615052
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.521870
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601233
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.521193
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519911
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.552784
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.521383
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.578277
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601911
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520644
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.504207
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.633037
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.666807
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596261
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526283
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.563786
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579749
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.656424
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526314
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514958
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603789
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547389
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.521916
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.631195
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.532060
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.502977
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523645
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.561425
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574349
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.487389
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.654927
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490461
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.525277
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538382
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.513308
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.489023
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548655
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603687
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.571394
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.628491
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519439
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577575
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591530
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531084
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.463621
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.392786
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.614551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.628085
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.495463
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515092
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.663048
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584250
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.597515
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.561239
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547414
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539180
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586467
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.442873
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.536471
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.450058
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.623374
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.609159
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.518414
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.478728
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.431067
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.524111
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.624819
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553578
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526596
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.464186
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602211
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.556607
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.469156
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490027
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.624612
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.472752
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.425548
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514939
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.455679
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.543707
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.631200
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.621473
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574374
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.496688
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.433931
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584847
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531188
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500686
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520288
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527478
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.465442
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547523
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.598938
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506706
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.472147
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.572378
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.475727
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.642948
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540045
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602076
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590685
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515761
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603633
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.589765
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.530934
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.545673
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.545340
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.669418
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.474118
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.617455
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.541474
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.588999
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533203
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591632
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515259
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.530080
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572096
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.624395
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.480804
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.634005
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596898
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.500498
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.417179
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.618778
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566942
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.475149
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533366
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526685
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567631
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.613427
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.636804
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.546405
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.449974
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.641500
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.688530
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558373
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.485247
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.456221
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.537614
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.656467
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.599231
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593917
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.517052
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501141
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.552656
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.644025
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.512885
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.663456
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591588
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.667509
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.632626
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.658260
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.565049
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.465954
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.700551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514757
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.605318
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.470120
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.479052
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515612
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584896
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.597993
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.442413
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506450
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505910
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538706
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581797
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505765
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.472387
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.621359
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514630
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553437
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.634140
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.595717
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.588062
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550974
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.542122
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.476575
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.647260
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.478690
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550140
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.448235
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.588933
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.529252
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.610128
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592439
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526057
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.544706
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.639179
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.384614
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.599227
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.693941
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.631894
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569326
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.465643
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.437722
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.492672
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.468738
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.492922
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.488284
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577318
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.464695
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583748
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.457025
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.673106
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.441141
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.574146
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.684801
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.474715
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.568963
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.594622
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.568727
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585352
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585019
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.594546
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574557
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539282
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.517144
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570740
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.403734
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.639462
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.564244
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505024
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547769
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.513507
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572123
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.436400
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.350336
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.508883
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569872
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567441
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584806
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.410408
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.417061
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.556032
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576749
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.636949
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.555543
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574151
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.433602
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.445528
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596083
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.454958
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.476027
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527241
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.616851
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.609087
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.681047
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.510840
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.555077
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581317
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.619822
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.481814
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.582415
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.488781
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.495936
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.557774
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.462950
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.600789
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.428594
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.560954
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.589825
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566568
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558996
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.431682
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.630478
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523908
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567054
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501045
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576007
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.420071
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.620273
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.571405
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.512745
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586506
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.467127
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.674140
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515626
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.559998
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.647438
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.563437
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503848
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548414
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574002
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.544879
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583690
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591301
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538522
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.581661
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.462589
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.469898
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.560460
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572477
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585990
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558257
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592238
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.467748
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.588088
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.452514
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.459892
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.557581
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.449118
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.565648
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.449663
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.485175
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.618131
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.446542
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.607325
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574079
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539287
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.595616
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.636807
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.605998
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.485006
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.573510
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581273
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.557897
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583558
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569676
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.609377
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.530260
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550894
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.451093
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540424
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558970
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519116
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.534028
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.524478
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.546952
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615594
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.489505
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.627701
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.609928
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501906
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553076
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.457368
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.523864
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.580615
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.565940
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590617
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567110
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.649422
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615724
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.402592
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.541717
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501665
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.429467
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.408218
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.646974
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.478730
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.504551
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533563
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.522152
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.532509
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.624490
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615815
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.516617
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.473831
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.558421
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533358
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.422810
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.475866
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.623368
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548599
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570807
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572552
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.627384
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.471786
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.612087
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.464639
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.613245
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.587973
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.634520
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.414913
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.600480
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.514246
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582331
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593454
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.467685
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.627880
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.525879
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.522944
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.557717
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.533952
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.448142
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.534295
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540778
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.408684
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.598885
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.643941
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.480936
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.571355
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.608231
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.484384
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591659
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490872
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.610951
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.597065
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.552827
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601940
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.423855
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574904
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501900
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.544040
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.624775
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.606607
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.696539
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.453052
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.379792
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527747
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.492669
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.527998
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.610409
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579832
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586447
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.585362
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558591
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.560701
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.486584
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572792
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567963
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.646716
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515325
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.462917
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.488989
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500704
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.481805
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.576096
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520680
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.504990
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523776
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.622010
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.648216
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.578857
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501198
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.541115
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507323
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572718
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.554022
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592935
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.498202
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.480385
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519461
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570129
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.452939
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.622672
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590919
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.391207
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.468674
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583248
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.536593
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575615
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.625878
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.438976
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.625530
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.564565
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576738
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.662723
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603261
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.481355
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611637
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582330
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538933
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593720
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.554940
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.442678
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531114
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.524567
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.494178
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602651
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.648834
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615774
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.450795
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.494349
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.496391
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576679
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539923
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.537169
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.626030
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576635
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540911
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601807
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497786
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.509035
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.442739
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.540255
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515194
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.567487
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523956
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.588769
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.525322
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506361
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.583006
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.532404
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.474992
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523465
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596150
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602041
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.689879
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519657
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.640798
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.460368
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.540841
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526353
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.623571
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602896
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.648574
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.625706
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.597200
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593417
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.632660
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.604753
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490835
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.536220
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.504012
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615163
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.598783
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586665
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.454232
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.605825
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.515820
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.430930
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586013
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575196
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.602969
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.554089
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519543
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.562901
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.458018
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.461338
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572265
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.628432
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.571223
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566736
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.557281
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519004
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497004
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.482614
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.545429
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.486072
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.468361
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.480877
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572677
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539058
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500574
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490789
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582274
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.545236
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.578633
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.471122
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.396665
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615062
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.558267
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526779
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579496
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.470699
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.429426
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.572360
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.490418
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.616338
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615368
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.629631
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611932
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.546044
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.615371
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.497576
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.576557
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.633076
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.610303
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.508577
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.603110
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.612103
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.553294
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506956
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.647796
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.626254
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.477862
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526000
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.583060
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582205
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.566162
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.562057
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.428700
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.584168
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.484703
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.592458
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.523003
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.519407
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.549555
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.607580
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.468481
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.621787
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.484235
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.541145
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538453
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531285
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.538357
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.517844
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.569362
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601553
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.544231
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507029
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.560494
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.543212
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.484867
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.547538
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.539013
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548705
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.606444
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550654
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.574624
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.629471
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.625135
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.508884
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.542835
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.564446
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.550462
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.481194
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.578720
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.582245
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.473617
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.502021
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.494991
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.611239
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.597195
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.460758
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.524768
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.662890
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.593058
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.622035
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.399081
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.535447
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.513361
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.475773
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.674465
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.626603
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.528007
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.461717
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577839
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.466686
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.576949
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.570485
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.556872
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.540944
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.483153
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596872
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.613836
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.607942
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581709
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501304
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.552668
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.600377
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.509112
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.503482
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.549193
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.505782
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.507236
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.558254
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.424737
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.590607
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.548510
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.601719
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.531561
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.586204
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.641814
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.520678
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.500254
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.702588
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.513801
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.669944
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.579539
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.501807
         Iterations 6
Optimization terminated successfully.
         Current function value: 1.656531
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506740
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.499043
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.506801
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.552540
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.551735
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.591380
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.596191
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.575529
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.502544
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.526164
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.453085
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.581391
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.638979
         Iterations 5
Optimization terminated successfully.
         Current function value: 1.577874
         Iterations 5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">estimates_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">coef_estimates</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">estimates_df</span>
 <span class="o">.</span><span class="n">melt</span><span class="p">()</span>
 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'alpha'</span><span class="p">:</span> <span class="sa">r</span><span class="s1">'Intercept ($\alpha$)'</span><span class="p">,</span> <span class="s1">'beta'</span><span class="p">:</span> <span class="sa">r</span><span class="s1">'Coefficient ($\beta$)'</span><span class="p">})</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'value'</span><span class="p">)</span> 
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="s1">'free_x'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">subplots_adjust</span><span class="o">=</span><span class="p">{</span><span class="s1">'hspace'</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">},</span>
                  <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                  <span class="n">title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">'Bootstraped (n=1000) parameter estimates'</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/19e37c645a603a1135b3d05c60ae424b4c074eff8e467e6828290340fc603272.png" src="_images/19e37c645a603a1135b3d05c60ae424b4c074eff8e467e6828290340fc603272.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">'date'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">boot_preds</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
    <span class="p">[</span><span class="n">poisson_predict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> 
     <span class="k">for</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span>
     <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">estimates_df</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">estimates_df</span><span class="o">.</span><span class="n">beta</span><span class="p">)]</span>
                                                     <span class="p">))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">pred</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'boot_preds'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">lo_pred</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'boot_preds'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">.025</span><span class="p">)))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">hi_pred</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="p">[</span><span class="s1">'boot_preds'</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">.975</span><span class="p">)))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> 
       <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">[[</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">,</span> <span class="s1">'pred'</span><span class="p">]]</span>
                 <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="s1">'date'</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s1">'kd_rolling_4'</span><span class="p">:</span> <span class="s1">'True Cases'</span><span class="p">,</span>
                           <span class="s1">'pred'</span><span class="p">:</span> <span class="s1">'Predicted Cases'</span><span class="p">}))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'date'</span><span class="p">,</span> <span class="s1">'value'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">'variable'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_ribbon</span><span class="p">(</span><span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'date'</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="s1">'lo_pred'</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="s1">'hi_pred'</span><span class="p">),</span>
                        <span class="n">fill</span><span class="o">=</span><span class="s1">'#D3894C'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.3</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">inherit_aes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_line</span><span class="p">()</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_point</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_light</span><span class="p">()</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span> <span class="n">legend_position</span><span class="o">=</span><span class="s1">'bottom'</span><span class="p">,</span>
                  <span class="n">legend_background</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">(),</span>
                  <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_color_manual</span><span class="p">([</span><span class="s1">'#D3894C'</span><span class="p">,</span> <span class="s1">'#435B97'</span><span class="p">,</span> <span class="s1">'black'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_linetype_manual</span><span class="p">([</span><span class="s1">'dashed'</span><span class="p">,</span> <span class="s1">'solid'</span><span class="p">,</span> <span class="s1">'dashed'</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_x_datetime</span><span class="p">(</span><span class="n">breaks</span><span class="o">=</span><span class="n">date_breaks</span><span class="p">(</span><span class="s1">'2 weeks'</span><span class="p">),</span> <span class="n">labels</span><span class="o">=</span><span class="n">date_format</span><span class="p">(</span><span class="s1">'%b-</span><span class="si">%d</span><span class="s1">'</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'KD cases [+0-3 days]'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'2011-04-23'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">4.8</span><span class="p">,</span> <span class="n">geom</span><span class="o">=</span><span class="s1">'text'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'RÂ²=43.6%'</span><span class="p">)</span>
<span class="p">))</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/clean_preds.pdf'</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">'tight'</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/315d28abb6bd95c8dac824bc58b0db434f11a7c0966cb9b783b26cd6278eb101.png" src="_images/315d28abb6bd95c8dac824bc58b0db434f11a7c0966cb9b783b26cd6278eb101.png"/>
</div>
</div>
</section>
<section id="treating-concentration-as-a-categorical-variable">
<h4>Treating concentration as a categorical variable<a class="headerlink" href="#treating-concentration-as-a-categorical-variable" title="Permalink to this heading">#</a></h4>
<p>Given the non-linearities we would expect on the effect of metals dose and likelihood of triggering the autoimmune response in vasculitis, it might be worth considering concentration as discrete categories. Letâ€™s take an initial look at how it would look:</p>
<section id="with-3-categories">
<h5>With 3 categories<a class="headerlink" href="#with-3-categories" title="Permalink to this heading">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cat_concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'cat_concentration'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_jitter</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.15</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_boxplot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Concentration of Cluster 1 metals [ng/mÂ³]'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'KD cases [0 to 3 days]'</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">axis_text_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">))</span>
       <span class="p">)</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f1c204b44f090adfbff897f6d260c586fb11231de46cc2e1bae624537f1bfa28.png" src="_images/f1c204b44f090adfbff897f6d260c586fb11231de46cc2e1bae624537f1bfa28.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cat_concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s1">'kd_rolling_4 ~ cat_concentration'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dd</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>      <td>kd_rolling_4</td>   <th>  R-squared:         </th> <td>   0.412</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.378</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   11.93</td>
</tr>
<tr>
  <th>Date:</th>             <td>jue, 02 jun 2022</td> <th>  Prob (F-statistic):</th> <td>0.000119</td>
</tr>
<tr>
  <th>Time:</th>                 <td>15:44:38</td>     <th>  Log-Likelihood:    </th> <td> -54.044</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>    37</td>      <th>  AIC:               </th> <td>   114.1</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>    34</td>      <th>  BIC:               </th> <td>   118.9</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     2</td>      <th>                     </th>     <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
                               <td></td>                                  <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P&gt;|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>                                                   <td>    1.5625</td> <td>    0.272</td> <td>    5.746</td> <td> 0.000</td> <td>    1.010</td> <td>    2.115</td>
</tr>
<tr>
  <th>cat_concentration[T.Interval(158.0, 250.0, closed='right')]</th> <td>    0.7102</td> <td>    0.426</td> <td>    1.667</td> <td> 0.105</td> <td>   -0.155</td> <td>    1.576</td>
</tr>
<tr>
  <th>cat_concentration[T.Interval(250.0, 341.0, closed='right')]</th> <td>    2.1375</td> <td>    0.438</td> <td>    4.875</td> <td> 0.000</td> <td>    1.246</td> <td>    3.029</td>
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
  <th>Omnibus:</th>       <td> 0.271</td> <th>  Durbin-Watson:     </th> <td>   1.265</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.873</td> <th>  Jarque-Bera (JB):  </th> <td>   0.096</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.121</td> <th>  Prob(JB):          </th> <td>   0.953</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 2.944</td> <th>  Cond. No.          </th> <td>    3.37</td>
</tr>
</tbody></table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cat_concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pairwise_tukeyhsd</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">'kd_rolling_4'</span><span class="p">],</span>
                                    <span class="n">groups</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">'cat_concentration'</span><span class="p">],</span>
                                    <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">))</span>
 <span class="o">.</span><span class="n">summary</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Multiple Comparison of Means - Tukey HSD, FWER=0.05</caption>
<tbody><tr>
      <th>group1</th>         <th>group2</th>     <th>meandiff</th>  <th>p-adj</th>  <th>lower</th>   <th>upper</th> <th>reject</th>
</tr>
<tr>
   <td>(67.0, 158.0]</td> <td>(158.0, 250.0]</td>  <td>0.7102</td>  <td>0.2323</td> <td>-0.3336</td> <td>1.7541</td>  <td>False</td>
</tr>
<tr>
   <td>(67.0, 158.0]</td> <td>(250.0, 341.0]</td>  <td>2.1375</td>  <td>0.0001</td> <td>1.0631</td>  <td>3.2119</td>  <td>True</td> 
</tr>
<tr>
  <td>(158.0, 250.0]</td> <td>(250.0, 341.0]</td>  <td>1.4273</td>  <td>0.0135</td> <td>0.2628</td>  <td>2.5918</td>  <td>True</td> 
</tr>
</tbody></table></div></div>
</div>
</section>
</section>
<section id="test-for-3-categories">
<h4>Test for 3 categories<a class="headerlink" href="#test-for-3-categories" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cluster_bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster_concentrations</span>
 <span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">cluster</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span>
 <span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">kd_ts</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cat_concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'Low'</span><span class="p">,</span> <span class="s1">'Medium'</span><span class="p">,</span> <span class="s1">'High'</span><span class="p">]))</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cluster_bins</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cat_concentration</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">concentration</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'Low</span><span class="se">\n</span><span class="s1">(0-114]'</span><span class="p">,</span> <span class="s1">'Medium</span><span class="se">\n</span><span class="s1">(114-227]'</span><span class="p">,</span> <span class="s1">'High</span><span class="se">\n</span><span class="s1">(227-341]'</span><span class="p">]))</span>
  <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'cat_concentration'</span><span class="p">,</span> <span class="s1">'kd_rolling_4'</span><span class="p">)</span> 
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_jitter</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_boxplot</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Concentration of Cluster 1 metals'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">'KD cases [0 to 3 days]'</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">axis_title</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span> <span class="n">panel_grid</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_blank</span><span class="p">())</span>
       <span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/boxplots.pdf'</span><span class="p">)</span>

<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/2017d646937e4d87a89ee7a0ab037f81c5397344394898da7f669a04ed0d1110.png" src="_images/2017d646937e4d87a89ee7a0ab037f81c5397344394898da7f669a04ed0d1110.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comp_lo_med_hi</span> <span class="o">=</span> <span class="n">dabest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cluster_bins</span><span class="p">,</span>
                             <span class="n">x</span><span class="o">=</span><span class="s1">'cat_concentration'</span><span class="p">,</span>
                             <span class="n">y</span><span class="o">=</span><span class="s1">'kd_rolling_4'</span><span class="p">,</span>
                             <span class="n">idx</span><span class="o">=</span><span class="p">[</span><span class="s1">'Low'</span><span class="p">,</span> <span class="s1">'Medium'</span><span class="p">,</span> <span class="s1">'High'</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">comp_med_hi</span> <span class="o">=</span> <span class="n">dabest</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cluster_bins</span><span class="p">,</span>
                            <span class="n">x</span><span class="o">=</span><span class="s1">'cat_concentration'</span><span class="p">,</span>
                            <span class="n">y</span><span class="o">=</span><span class="s1">'kd_rolling_4'</span><span class="p">,</span>
                            <span class="n">idx</span><span class="o">=</span><span class="p">[</span><span class="s1">'Medium'</span><span class="p">,</span> <span class="s1">'High'</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bootstrap_test_results</span> <span class="o">=</span> <span class="p">(</span><span class="n">comp_lo_med_hi</span>
                         <span class="o">.</span><span class="n">mean_diff</span>
                         <span class="o">.</span><span class="n">results</span>
                         <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp_med_hi</span><span class="o">.</span><span class="n">mean_diff</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
                         
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">bootstrap_test_results</span>
   <span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">'bootstraps'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">test_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">test</span> <span class="o">+</span> <span class="s1">' - '</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">control</span><span class="p">)</span>
 <span class="p">[[</span><span class="s1">'test_label'</span><span class="p">,</span> <span class="s1">'difference'</span><span class="p">,</span> <span class="s1">'bootstraps'</span><span class="p">,</span> <span class="s1">'pvalue_permutation'</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">'bootstraps'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>test_label</th>
      <th>difference</th>
      <th>pvalue_permutation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Medium - Low</td>
      <td>0.710227</td>
      <td>0.0940</td>
    </tr>
    <tr>
      <th>0</th>
      <td>High - Medium</td>
      <td>1.427273</td>
      <td>0.0124</td>
    </tr>
    <tr>
      <th>1</th>
      <td>High - Low</td>
      <td>2.137500</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="s1">'#EEA236'</span>
<span class="n">b</span> <span class="o">=</span> <span class="s1">'#A94442'</span>
<span class="n">c</span> <span class="o">=</span> <span class="s1">'#5CB85C'</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">bootstrap_test_results</span>
 <span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s1">'bootstraps'</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">test_label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">control</span> <span class="o">+</span> <span class="s1">'-'</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bootstraps</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">dd</span><span class="o">.</span><span class="n">bootstraps</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
 <span class="p">[[</span><span class="s1">'test_label'</span><span class="p">,</span> <span class="s1">'difference'</span><span class="p">,</span> <span class="s1">'bootstraps'</span><span class="p">,</span> <span class="s1">'pvalue_permutation'</span><span class="p">]]</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> 
         <span class="n">dd</span><span class="o">.</span><span class="n">test_label</span> <span class="o">+</span>  <span class="s1">':</span><span class="se">\n</span><span class="s1"> $\mu_</span><span class="si">{diff}</span><span class="s1">$ = '</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">difference</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="o">+</span> <span class="s1">', $p$ = '</span> <span class="o">+</span> <span class="n">dd</span><span class="o">.</span><span class="n">pvalue_permutation</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
 <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
 <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">dd</span><span class="p">:</span> <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="s1">'bootstraps'</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">'test_label'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_density</span><span class="p">(</span><span class="n">bw</span><span class="o">=</span><span class="mf">.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.6</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s1">'label'</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">'Bootstrapped Mean Diffs'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme_void</span><span class="p">()</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span><span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                  <span class="n">axis_text_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">va</span><span class="o">=</span><span class="s1">'top'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
                  <span class="n">axis_title_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">))</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_manual</span><span class="p">([</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span><span class="p">])</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">linetype</span><span class="o">=</span><span class="s1">'dashed'</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">guides</span><span class="p">(</span><span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
      <span class="p">)</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">'../output/figures/bs.pdf'</span><span class="p">)</span>
 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/5dddb18b55f52e799fac90584ceb6df72c3b6d2506747ba677138559fe7438b2.png" src="_images/5dddb18b55f52e799fac90584ceb6df72c3b6d2506747ba677138559fe7438b2.png"/>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev" href="hysplit_trajectories.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Modelling the air sources with HYSPLIT</p>
      </div>
    </a>
    <a class="right-next" href="weekly-cycle-figures-ang.html" title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Sub-weekly cycle Figures</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preamble">Preamble</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imports">Imports</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#python">Python</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#r">R</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pre-sets">Pre-sets</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-preprocessing">Data Preprocessing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reading">Reading</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cleaning">Cleaning</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis">Analysis</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#preliminary-view">Preliminary view</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pairwise-correlations">Pairwise correlations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clustering">Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#poisson-regression">Poisson Regression</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#bootstrapped-ci">Bootstrapped CI</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#treating-concentration-as-a-categorical-variable">Treating concentration as a categorical variable</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#with-3-categories">With 3 categories</a></li>
</ul>
</li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#test-for-3-categories">Test for 3 categories</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alejandro Fontal, Albert Navarro, Xavier RodÃ³
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      Â© Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  
</body></html>