<!DOCTYPE html>
<html><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/><meta content="Docutils 0.17.1: http://docutils.sourceforge.net/" name="generator"/>

    <title>Metals in air masses and their effect on KD onset â€” KD and metal rich aerosols</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet"/>

    
  <link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>

    <link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" rel="stylesheet" type="text/css"/>
    <link href="_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/mystnb.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
    <link href="_static/custom.css" rel="stylesheet" type="text/css"/>
    <link href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" rel="stylesheet" type="text/css"/>
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf" rel="preload"/>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "https://github.com/AlFontal/kd-metals-swc");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link href="https://alfontal.github.io/kd-metals-swc/metals.html" rel="canonical"/>
    <link href="_static/favicon.ico" rel="shortcut icon"/>
    <link href="genindex.html" rel="index" title="Index"/>
    <link href="search.html" rel="search" title="Search"/>
    <link href="weekly-cycle-figures-ang.html" rel="next" title="Sub-weekly cycle Figures"/>
    <link href="hysplit_trajectories.html" rel="prev" title="Modelling the air sources with HYSPLIT"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="None" name="docsearch:language"/>
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DC18W62KP8"></script>
<script>
                    window.dataLayer = window.dataLayer || [];
                    function gtag(){ dataLayer.push(arguments); }
                    gtag('js', new Date());
                    gtag('config', 'G-DC18W62KP8');
                </script>

  </head>
  <body data-offset="60" data-spy="scroll" data-target="#bd-toc-nav">
<!-- Checkboxes to toggle the left sidebar -->
<input aria-label="Toggle navigation sidebar" class="sidebar-toggle" id="__navigation" name="__navigation" type="checkbox"/>
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input aria-label="Toggle in-page Table of Contents" class="sidebar-toggle" id="__page-toc" name="__page-toc" type="checkbox"/>
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img alt="logo" class="logo" src="_static/logo.png"/>
      
      
      <h1 class="site-logo" id="site-title">KD and metal rich aerosols</h1>
      
    </a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="icon fas fa-search"></i>
  <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="README.html">
                    README
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notebooks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="hysplit_trajectories.html">
   HYSPLIT backtrajectories
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Chemistry and KD synchrony
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="weekly-cycle-figures-ang.html">
   Sub-weekly Cycle Figures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="other_diseases_weekly.html">
   Weekly cycle in other diseases
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<div>           
<hr/>
<a href="https://helical-itn.github.io/">
<img src="https://helical-itn.github.io/assets/institutional_logos/helical-logo.png" width="200px"/>
</a>
<p></p>
<a href="https://www.isglobal.org/en/-/clima-y-salud">
<img src="https://www.isglobal.org/isglobal-new-theme/assets/images/isglobal/logo-isglobal-en.png" width="200px"/>
</a>

</div>

            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label class="headerbtn" data-placement="right" data-toggle="tooltip" for="__navigation" title="Toggle navigation">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button aria-label="Launch interactive content" class="headerbtn menu-dropdown__trigger">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://mybinder.org/v2/gh/AlFontal/kd-metals-swc/main?urlpath=tree/metals.ipynb" title="Launch on Binder">
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg"/>
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button class="headerbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button aria-label="Source repositories" class="headerbtn menu-dropdown__trigger">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/AlFontal/kd-metals-swc" title="Source repository">
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="https://github.com/AlFontal/kd-metals-swc/issues/new?title=Issue%20on%20page%20%2Fmetals.html&amp;body=Your%20issue%20content%20here." title="Open an issue">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button aria-label="Download this page" class="headerbtn menu-dropdown__trigger">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a class="headerbtn" data-placement="left" data-toggle="tooltip" href="_sources/metals.ipynb" title="Download source file">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button class="headerbtn" data-placement="left" data-toggle="tooltip" onclick="printPdf(this)" title="Print to PDF">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label class="headerbtn headerbtn-page-toc" for="__page-toc">
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav aria-label="Page" id="bd-toc-nav">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#python">
       Python
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#r">
       R
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-preprocessing">
   Data Preprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading">
   Reading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cleaning">
     Cleaning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analysis">
   Analysis
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preliminary-view">
     Preliminary view
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pairwise-correlations">
     Pairwise correlations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#clustering">
     Clustering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#poisson-regression">
     Poisson Regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bootstrapped-ci">
       Bootstrapped CI
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#treating-concentration-as-a-categorical-variable">
       Treating concentration as a categorical variable
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#with-3-categories">
         With 3 categories
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#test-for-3-categories">
       Test for 3 categories
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div class="onlyprint" id="jb-print-docs-body">
                <h1>Metals in air masses and their effect on KD onset</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports">
     Imports
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#python">
       Python
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#r">
       R
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-sets">
     Pre-sets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-preprocessing">
   Data Preprocessing
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#reading">
   Reading
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cleaning">
     Cleaning
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#analysis">
   Analysis
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preliminary-view">
     Preliminary view
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pairwise-correlations">
     Pairwise correlations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#clustering">
     Clustering
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#poisson-regression">
     Poisson Regression
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#bootstrapped-ci">
       Bootstrapped CI
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#treating-concentration-as-a-categorical-variable">
       Treating concentration as a categorical variable
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#with-3-categories">
         With 3 categories
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#test-for-3-categories">
       Test for 3 categories
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="metals-in-air-masses-and-their-effect-on-kd-onset">
<h1>Metals in air masses and their effect on KD onset<a class="headerlink" href="#metals-in-air-masses-and-their-effect-on-kd-onset" title="Permalink to this headline">#</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#preamble" id="id1">Preamble</a></p>
<ul>
<li><p><a class="reference internal" href="#imports" id="id2">Imports</a></p></li>
<li><p><a class="reference internal" href="#pre-sets" id="id3">Pre-sets</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#data-preprocessing" id="id4">Data Preprocessing</a></p></li>
<li><p><a class="reference internal" href="#reading" id="id5">Reading</a></p>
<ul>
<li><p><a class="reference internal" href="#cleaning" id="id6">Cleaning</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#analysis" id="id7">Analysis</a></p>
<ul>
<li><p><a class="reference internal" href="#preliminary-view" id="id8">Preliminary view</a></p></li>
<li><p><a class="reference internal" href="#pairwise-correlations" id="id9">Pairwise correlations</a></p></li>
<li><p><a class="reference internal" href="#clustering" id="id10">Clustering</a></p></li>
<li><p><a class="reference internal" href="#poisson-regression" id="id11">Poisson Regression</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="preamble">
<h2><a class="toc-backref" href="#id1">Preamble</a><a class="headerlink" href="#preamble" title="Permalink to this headline">#</a></h2>
<section id="imports">
<h3><a class="toc-backref" href="#id2">Imports</a><a class="headerlink" href="#imports" title="Permalink to this headline">#</a></h3>
<section id="python">
<h4>Python<a class="headerlink" href="#python" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%load_ext rpy2.ipython
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import dabest

import numpy as np
import pandas as pd
import plotnine as p9

from collections import defaultdict
from matplotlib import pyplot as plt
from mizani.breaks import date_breaks
import statsmodels.formula.api as smf
from mizani.formatters import date_format
from statsmodels.stats.multicomp import pairwise_tukeyhsd
from scipy.cluster.hierarchy import dendrogram, linkage, fcluster
</pre></div>
</div>
</div>
</div>
</section>
<section id="r">
<h4>R<a class="headerlink" href="#r" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%R
library(dplyr)
library(ggplot2)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="pre-sets">
<h3><a class="toc-backref" href="#id3">Pre-sets</a><a class="headerlink" href="#pre-sets" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>p9.options.set_option('dpi', 200)
p9.options.set_option('figure_size', (4, 3))
p9.options.set_option('base_family', 'Bitstream Vera Serif')
p9.theme_set(p9.theme_bw() + p9.theme(axis_text=p9.element_text(size=7),
                                      axis_title=p9.element_text(size=9)))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;plotnine.themes.theme_bw.theme_bw at 0x7fa497689f40&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="data-preprocessing">
<h2><a class="toc-backref" href="#id4">Data Preprocessing</a><a class="headerlink" href="#data-preprocessing" title="Permalink to this headline">#</a></h2>
</section>
<section id="reading">
<h2><a class="toc-backref" href="#id5">Reading</a><a class="headerlink" href="#reading" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>raw_chem_df = pd.read_excel('../data/KD_chemistry_2011.xlsx', engine='openpyxl', sheet_name=0)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kd_df = (pd.read_excel('../data/KD_chemistry_2011.xlsx', engine='openpyxl', sheet_name=0)
         .iloc[72:80]
        )
</pre></div>
</div>
</div>
</div>
<section id="cleaning">
<h3><a class="toc-backref" href="#id6">Cleaning</a><a class="headerlink" href="#cleaning" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>long_chemistry = (raw_chem_df
                 .iloc[1:71, :38]
                 .set_index('Filter')
                 .T
                 .reset_index()
                 .assign(date=lambda dd: pd.to_datetime(dd['index'], dayfirst=True))
                 .drop(columns=['index', np.NaN, 'ng/m3'])
                 .melt('date', var_name='compound', value_name='concentration')
                 .assign(concentration=lambda dd: dd.concentration.astype(float))
                 .assign(compound=lambda dd: dd['compound'].str.rstrip())
                 )
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>long_chemistry.head()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>compound</th>
      <th>concentration</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011-03-22</td>
      <td>PM10</td>
      <td>39.650350</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-03-23</td>
      <td>PM10</td>
      <td>22.937063</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-03-24</td>
      <td>PM10</td>
      <td>36.391416</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-03-25</td>
      <td>PM10</td>
      <td>27.501910</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-03-26</td>
      <td>PM10</td>
      <td>28.251748</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>wide_chemistry = long_chemistry.pivot('date', 'compound', 'concentration')
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>kd_ts = (kd_df
         .set_index('Filter')
         .T
         .dropna()
         .reset_index(drop=True)
         .rename(columns={f'KD cases D{i}': f'kd_lag_{i}' for i in range(4)})
         .rename(columns={'KD cases D03': 'kd_rolling_4'})
         [['date'] + [f'kd_lag_{i}' for i in range(4)] + ['kd_rolling_4']]
         .assign(kd_rolling_4=lambda dd: dd.kd_rolling_4.astype(int))
)
kd_ts
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Filter</th>
      <th>date</th>
      <th>kd_lag_0</th>
      <th>kd_lag_1</th>
      <th>kd_lag_2</th>
      <th>kd_lag_3</th>
      <th>kd_rolling_4</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011-03-22</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-03-23</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-03-24</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-03-25</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-03-26</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2011-03-27</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2011-03-28</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>5</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2011-03-29</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2011-03-30</td>
      <td>1</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2011-03-31</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2011-04-01</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2011-04-02</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2011-04-03</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>13</th>
      <td>2011-04-04</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2011-04-05</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>15</th>
      <td>2011-04-06</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2011-04-07</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>2011-04-08</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2011-04-09</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>19</th>
      <td>2011-04-10</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2011-04-11</td>
      <td>0</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>21</th>
      <td>2011-04-12</td>
      <td>4</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>5</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2011-04-13</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>23</th>
      <td>2011-04-14</td>
      <td>0</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2011-04-15</td>
      <td>1</td>
      <td>2</td>
      <td>0</td>
      <td>1</td>
      <td>4</td>
    </tr>
    <tr>
      <th>25</th>
      <td>2011-04-16</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2011-04-17</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>27</th>
      <td>2011-04-18</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2011-04-19</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <th>29</th>
      <td>2011-04-20</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2011-04-21</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
    </tr>
    <tr>
      <th>31</th>
      <td>2011-04-22</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>3</td>
    </tr>
    <tr>
      <th>32</th>
      <td>2011-04-23</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>33</th>
      <td>2011-04-24</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>34</th>
      <td>2011-04-25</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>35</th>
      <td>2011-04-26</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>36</th>
      <td>2011-04-27</td>
      <td>0</td>
      <td>0</td>
      <td>2</td>
      <td>0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="analysis">
<h2><a class="toc-backref" href="#id7">Analysis</a><a class="headerlink" href="#analysis" title="Permalink to this headline">#</a></h2>
<section id="preliminary-view">
<h3><a class="toc-backref" href="#id8">Preliminary view</a><a class="headerlink" href="#preliminary-view" title="Permalink to this headline">#</a></h3>
<p>Just visualizing the change in KD cases (on a 4 day rolling window from 0 to +3 days), the aggregated concentration of all metals, and the concentration of PM10 we can already see the high degree of synchrony between these three variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(long_chemistry
 .loc[lambda dd: dd.compound.isin(['PM10', 'METALLS'])]
 .assign(group=lambda dd: np.where(dd.compound=='METALLS','Metals [ng/mÂ³]', 'PM$_{10}$ [Âµg/mÂ³]'))
 .append(kd_ts[['date', 'kd_rolling_4']]
         .assign(group='KD cases (4 day rolling window)')
         .rename(columns={'kd_rolling_4': 'concentration'}))
 .assign(concentration=lambda dd: dd.concentration.astype(float))
 .pipe(lambda dd: p9.ggplot(dd)
       + p9.aes('date', 'concentration')
         + p9.geom_line() 
         + p9.facet_wrap('group', ncol=1, scales='free_y')
         + p9.theme(figure_size=(5, 3))
         + p9.labs(x='', y='')
         + p9.scale_x_datetime(breaks=date_breaks('2 week'))
      )
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_23_1.png" src="_images/metals_23_1.png"/>

</div>
</div>
</section>
<section id="pairwise-correlations">
<h3><a class="toc-backref" href="#id9">Pairwise correlations</a><a class="headerlink" href="#pairwise-correlations" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>long_metals = (raw_chem_df
               .iloc[22:70, :38]
               .set_index('Filter')
               .T
               .reset_index()
               .assign(date=lambda dd: pd.to_datetime(dd['index'], dayfirst=True))
               .fillna(0)
               .drop(columns='index')
               .melt('date', var_name='compound', value_name='concentration')
               .assign(concentration=lambda dd: dd.concentration.astype(float))
               .assign(compound=lambda dd: dd['compound'].str.rstrip())
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>wide_metals = long_metals.pivot('date', 'compound', 'concentration')
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>pairwise_corrs = (wide_metals
                 .corr()
                 .reset_index()
                 .melt('compound', var_name='compound_b', value_name='r')
                 .loc[lambda dd: dd.compound &lt;= dd.compound_b]
                 )
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = (pairwise_corrs
.loc[lambda dd: dd['compound']!=dd['compound_b']]
 .pipe(lambda dd: p9.ggplot(dd) 
       + p9.aes('compound', 'compound_b') 
       + p9.geom_tile(p9.aes(fill='r'))
       + p9.theme_classic()
       + p9.scale_fill_continuous('RdBu_r', limits=(-1, 1))
       + p9.theme(figure_size=(5.5, 5.5), dpi=150, axis_line=p9.element_blank(), axis_text=p9.element_blank(),
                  axis_ticks=p9.element_blank(), legend_position=(.65, .35), legend_key_size=10)
       + p9.labs(x='', y='', fill="Pearson's $r$")
       + p9.geom_text(p9.aes(label='compound', x='compound'), y=49.5, data=dd[['compound']].drop_duplicates(),
                      angle=90, va='top', ha='center', size=6)
        + p9.geom_text(p9.aes(label='compound_b + "   "'), data=dd.loc[dd.compound=='As'], ha='right', size=6)
        + p9.scale_y_discrete(expand=(0, 8, 0, 4))
        + p9.scale_x_discrete(expand=(0, 8, 0, 4))

      )
    ).draw()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_28_0.png" src="_images/metals_28_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f.savefig('../output/figures/corrmatrix.pdf',  bbox_inches='tight')
</pre></div>
</div>
</div>
</div>
<p>The pairwise correlations plot showcases how multicolinear this dataset, with most compounds following a similar pattern among the 37 samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dendrogramcorrmatrix = wide_metals.corr()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>linkage_matrix = linkage(wide_metals.T, 'single', 'correlation')
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>labels = wide_metals.columns
</pre></div>
</div>
</div>
</div>
</section>
<section id="clustering">
<h3><a class="toc-backref" href="#id10">Clustering</a><a class="headerlink" href="#clustering" title="Permalink to this headline">#</a></h3>
<p>Given the highly colinear dataset we have in hand, it makes no sense to try and separe the signal of most of these metals from each other. What I am going to do is performe agglomerative hierarchical clustering using 1 - correlation across each of these metals and generate groups that covariate across the samples in a similar manner:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>plt.style.use('seaborn-white')
fig, ax = plt.subplots(figsize=(6, 3), dpi=125)
dendrogram(linkage_matrix, labels=labels, color_threshold=.3, ax=ax)
ax.set_ylabel("Distance (1 - Pearson's R)")
plt.savefig('../output/figures/dendrogram.pdf', bbox_inches='tight')
plt.show()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_36_0.png" src="_images/metals_36_0.png"/>
</div>
</div>
<p>If I set the threshold on a distance of 0.3 (or a Pearson correlation of &lt; 0.7â€¦) what we get is a huge group with many metals, a second cluster with <code class="docutils literal notranslate"><span class="pre">Ge</span></code> and <code class="docutils literal notranslate"><span class="pre">Ni</span></code> and several individual metals as sole leaves.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>big_metals_cluster = ['As', 'Ba', 'Be', 'Bi', 'Cd', 'Ce', 'Co', 'Cs', 'Cu', 'Dy', 'Er', 'Eu',
                      'Ga', 'Gd', 'Ho', 'La', 'Li', 'Lu', 'Mn', 'Nb', 'Nd', 'Pb', 'Pr', 'Rb', 'Se',
                      'Sm', 'Sn', 'Sr', 'Tb', 'Th', 'Ti', 'Tl', 'Tm', 'U', 'V', 'Y', 'Yb', 'Zn']
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>metals = wide_metals.columns
clusters = fcluster(linkage_matrix, 0.3, criterion='distance')
metal_clusters = {metal: cluster for metal, cluster in zip(metals, clusters)}
cluster_metals = defaultdict(list)
for cluster, metal in zip(clusters, metals):
    cluster_metals[cluster] += [metal]
    
for cluster, metals in cluster_metals.items():
    print(f'Cluster {cluster}:\n {metals}\n')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cluster 1:
 ['As', 'Ba', 'Be', 'Bi', 'Cd', 'Ce', 'Co', 'Cs', 'Cu', 'Dy', 'Er', 'Eu', 'Ga', 'Gd', 'Ho', 'La', 'Li', 'Lu', 'Mn', 'Nb', 'Nd', 'Pb', 'Pr', 'Rb', 'Se', 'Sm', 'Sn', 'Sr', 'Tb', 'Th', 'Ti', 'Tl', 'Tm', 'U', 'V', 'Y', 'Yb', 'Zn']

Cluster 7:
 ['Cr']

Cluster 2:
 ['Ge', 'Ni']

Cluster 5:
 ['Hf']

Cluster 6:
 ['Mo']

Cluster 4:
 ['Sb']

Cluster 10:
 ['Sc']

Cluster 9:
 ['Ta']

Cluster 8:
 ['W']

Cluster 3:
 ['Zr']
</pre></div>
</div>
</div>
</div>
<p>The aggregated variation in concentration of each clusters looks as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import string
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def min_max_norm(x):
    return (x - min(x)) / (max(x) - min(x))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>min_max_metals = (long_metals
 .groupby('compound')
 .apply(lambda dd: dd.assign(concentration=min_max_norm(dd.concentration)))
 .reset_index(drop=True)
  .assign(cluster=lambda dd: dd.compound.map(metal_clusters))
 .assign(metals=lambda d: d.cluster.map(cluster_metals))
 .assign(cluster_label=lambda dd: 'Cluster ' + dd.cluster.apply(lambda x: string.ascii_uppercase[x - 1]) + ': ' 
         + dd.metals.apply(lambda x: ', '.join(x) if x != big_metals_cluster else '38 metals'))

)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = (min_max_metals
  .groupby(['cluster_label', 'date'])
 .concentration.mean()
 .reset_index()
  .pipe(lambda dd: p9.ggplot(dd) 
       + p9.aes('date', 'concentration', color='cluster_label=="Cluster A: 38 metals"') 
       + p9.geom_line(size=1)
       + p9.geom_line(data=min_max_metals, mapping=p9.aes(group='compound'), alpha=.1)
       
       + p9.facet_wrap('cluster_label', scales='fixed', ncol=2)
       + p9.scale_x_datetime(breaks=date_breaks('2 weeks'), labels=date_format('%b-%d'))
       + p9.scale_y_continuous(breaks=[0, .5, 1])
       + p9.scale_color_manual(['black', 'red'])
       + p9.theme(figure_size=(4.5, 5), panel_grid=p9.element_blank())
       + p9.labs(x='Date', y='Min-maxed Mean Concentration')
       + p9.guides(color=False)
      )
).draw()
f.savefig('../output/figures/clusters_ts.pdf', bbox_inches='tight')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_45_1.png" src="_images/metals_45_1.png"/>
</div>
</div>
<p>And we can visualize the intra-cluster 1 variability in the following figure, with the shadowed lines representing the min-maxed concentration of each individual metal within the cluster, and the dark thick line representing the average value of all the metals in the claster at each sample:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(long_metals
 .assign(cluster=lambda dd: dd.compound.map(metal_clusters))
 .loc[lambda dd: dd.cluster==1]
 .groupby(['compound'])
 .apply(lambda dd: dd.assign(concentration=min_max_norm(dd.concentration)))
 .reset_index(drop=True)
 .pipe(lambda dd: p9.ggplot(dd)
       + p9.aes('date', 'concentration')
       + p9.geom_line(p9.aes(group='compound'), alpha=.15)
       + p9.stat_summary(fun_y=np.mean, geom='line', size=1.5)
       + p9.theme(figure_size=(5, 2.5))
       + p9.scale_x_datetime(breaks=date_breaks('2 weeks'), labels=date_format('%b-%d'))
       + p9.labs(x='', y='Min-Maxed Concentration', title='Metals Cluster A'))
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_48_0.png" src="_images/metals_48_0.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster_concentrations = \
(long_metals
 .assign(cluster=lambda dd: dd.compound.map(metal_clusters))
 .groupby(['cluster', 'date'])
 .concentration.sum()
 .reset_index()
)
(cluster_concentrations
  .pipe(lambda dd: p9.ggplot(dd) 
       + p9.aes('date', 'concentration') 
       + p9.geom_line() 
       + p9.facet_wrap(['"Metals Cluster " + cluster.astype(str)'], scales='free_y', ncol=2)
       + p9.scale_x_datetime(breaks=date_breaks('3 weeks'))
       + p9.theme(figure_size=(7, 6), subplots_adjust={'wspace': 0.175})
       + p9.labs(x='Date', y='Concentration [ng/mÂ³]')
      )
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_49_1.png" src="_images/metals_49_1.png"/>

</div>
</div>
</section>
<section id="poisson-regression">
<h3><a class="toc-backref" href="#id11">Poisson Regression</a><a class="headerlink" href="#poisson-regression" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>poisson_regression_df = cluster_concentrations.query('cluster==1').merge(kd_ts)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>poisson_model = smf.poisson('kd_rolling_4 ~ concentration', data=poisson_regression_df).fit()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Optimization terminated successfully.
         Current function value: 1.560838
         Iterations 5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>poisson_model.summary()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Poisson Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>     <td>kd_rolling_4</td>   <th>  No. Observations:  </th>  <td>    37</td>  
</tr>
<tr>
  <th>Model:</th>                <td>Poisson</td>     <th>  Df Residuals:      </th>  <td>    35</td>  
</tr>
<tr>
  <th>Method:</th>                 <td>MLE</td>       <th>  Df Model:          </th>  <td>     1</td>  
</tr>
<tr>
  <th>Date:</th>            <td>jue, 02 jun 2022</td> <th>  Pseudo R-squ.:     </th>  <td>0.09547</td> 
</tr>
<tr>
  <th>Time:</th>                <td>15:39:54</td>     <th>  Log-Likelihood:    </th> <td> -57.751</td> 
</tr>
<tr>
  <th>converged:</th>             <td>True</td>       <th>  LL-Null:           </th> <td> -63.846</td> 
</tr>
<tr>
  <th>Covariance Type:</th>     <td>nonrobust</td>    <th>  LLR p-value:       </th> <td>0.0004802</td>
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
        <td></td>           <th>coef</th>     <th>std err</th>      <th>z</th>      <th>P&gt;|z|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>     <td>   -0.1577</td> <td>    0.328</td> <td>   -0.481</td> <td> 0.630</td> <td>   -0.800</td> <td>    0.485</td>
</tr>
<tr>
  <th>concentration</th> <td>    0.0048</td> <td>    0.001</td> <td>    3.495</td> <td> 0.000</td> <td>    0.002</td> <td>    0.007</td>
</tr>
</tbody></table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>preds = poisson_model.predict()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = (kd_ts.assign(preds=preds)
 [['date', 'kd_rolling_4', 'preds']]
 .melt('date')
 .replace({'preds': 'Predicted cases',
           'kd_rolling_4': 'True cases'})
 .pipe(lambda dd: 
       p9.ggplot(dd)
       + p9.aes('date', 'value', color='Filter', linetype='Filter')
       + p9.geom_line()
       + p9.geom_point(size=1)
       + p9.scale_color_manual(['#D3894C', '#435B97'])
       + p9.scale_linetype_manual(['dashed', 'solid'])
       + p9.scale_x_datetime(breaks=date_breaks('2 weeks'), labels=date_format('%b-%d'))
       + p9.labs(x='', y='KD cases [+0-3 days]', color='', linetype='')
       + p9.annotate(x='2011-04-23', y=4.8, geom='text', label='RÂ²=43.6%')
       + p9.theme(figure_size=(5, 2.5), legend_position='bottom',
                  legend_background= p9.element_blank())

)
).draw()
f.savefig('../output/figures/poisson_preds.pdf', bbox_inches='tight')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_56_0.png" src="_images/metals_56_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def poisson_predict(x, alpha, beta):
    return np.exp(alpha + x * beta)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>double_axis_fig_data = (cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts)
 [['date', 'concentration', 'kd_rolling_4']]
 .melt('date')
 .replace({'concentration': 'Aggregated Concentration of Cluster A metals [ng/mÂ³]',
           'kd_rolling_4': 'KD cases +0-3 days'})
                       )
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>f = (double_axis_fig_data
  .pipe(lambda dd: p9.ggplot(dd) 
        + p9.aes('date', 'value') 
        + p9.geom_line(size=.8)
        + p9.facet_wrap('variable', scales='free_y', ncol=1)
        + p9.theme(figure_size=(4.5, 3))
        + p9.labs(x='', y='')
        + p9.scale_x_datetime(breaks=date_breaks('2 weeks'), labels=date_format('%b-%d'))
)
).draw()
f.savefig('../output/figures/kd_vs_cluster_ts.pdf', bbox_inches='tight')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_60_1.png" src="_images/metals_60_1.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>double_axis_fig_data.groupby(['variable']).value.max()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>variable
Aggregated Concentration of Cluster A metals [ng/mÂ³]    340.933779
KD cases +0-3 days                                        5.000000
Name: value, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>double_axis_fig_data = (double_axis_fig_data
 .replace({'Aggregated Concentration of Cluster A metals [ng/mÂ³]': 'cluster_a',
           'KD cases +0-3 days': 'kd_cases'})
 .pivot('date', 'variable', 'value')        
 
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>double_axis_fig_data = double_axis_fig_data.reset_index()
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%R -i double_axis_fig_data -w 650 -h 350 -r 150

coef &lt;- 340 / 5 + .005

f &lt;- ggplot(double_axis_fig_data) + 
    aes(date, kd_cases) +
    theme_bw() +
    labs(x='Date') +
    scale_y_continuous(name='KD cases +0-3 days',
                       sec.axis=sec_axis(trans=~.*coef, name='Cluster A metals [ng/mÂ³]')) + 
    geom_line(aes(y=cluster_a / coef), color='red', alpha=1, size=1) +
    geom_line(size=1) +
    theme(axis.title.y.right = element_text(color = 'red', size=11),
          axis.title.y.left = element_text(size=11),
          panel.grid=element_blank()) 
ggsave('../output/figures/metals_kd_shared.pdf', f, device=cairo_pdf)
f
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_64_1.png" src="_images/metals_64_1.png"/>
</div>
</div>
<section id="bootstrapped-ci">
<h4>Bootstrapped CI<a class="headerlink" href="#bootstrapped-ci" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>coef_estimates = dict(alpha=[], beta=[])
for _ in range(1000):
    boot_df = poisson_regression_df.sample(19)
    poisson= smf.poisson('kd_rolling_4 ~ concentration', data=boot_df).fit()
    a, b = poisson.params
    coef_estimates['alpha'].append(a)
    coef_estimates['beta'].append(b)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>estimates_df = pd.DataFrame(coef_estimates)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(estimates_df
 .melt()
 .replace({'alpha': r'Intercept ($\alpha$)', 'beta': r'Coefficient ($\beta$)'})
 .pipe(lambda dd: p9.ggplot(dd) + p9.aes('value') 
       + p9.facet_wrap('variable', ncol=1, scales='free_x')
       + p9.geom_histogram(bins=20)
       + p9.theme(subplots_adjust={'hspace': 0.3},
                  figure_size=(5, 4),
                  title=p9.element_text(size=10))
       + p9.labs(x='', y='', title='Bootstraped (n=1000) parameter estimates')
    )
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_69_1.png" src="_images/metals_69_1.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts, on='date')
 .assign(boot_preds=lambda dd: dd.concentration.apply(lambda x:
    [poisson_predict(x, alpha, beta) 
     for alpha, beta
     in zip(estimates_df.alpha, estimates_df.beta)]
                                                     ))
 .assign(pred=lambda dd: dd['boot_preds'].apply(lambda x: np.median(x)))
 .assign(lo_pred=lambda dd: dd['boot_preds'].apply(lambda x: np.quantile(x, .025)))
 .assign(hi_pred=lambda dd: dd['boot_preds'].apply(lambda x: np.quantile(x, .975)))
 .pipe(lambda dd: 
       p9.ggplot(dd[['date', 'kd_rolling_4', 'pred']]
                 .melt('date')
                 .replace({'kd_rolling_4': 'True Cases',
                           'pred': 'Predicted Cases'}))
       + p9.aes('date', 'value', color='variable', linetype='variable')
       + p9.geom_ribbon(p9.aes(x='date', ymin='lo_pred', ymax='hi_pred'),
                        fill='#D3894C', alpha=.3, data=dd, inherit_aes=False)
       + p9.geom_line()
       + p9.geom_point(size=1)
       + p9.theme_light()
       + p9.theme(figure_size=(5, 2.5), legend_position='bottom',
                  legend_background=p9.element_blank(),
                  panel_grid=p9.element_blank())
       + p9.scale_color_manual(['#D3894C', '#435B97', 'black'])
       + p9.scale_linetype_manual(['dashed', 'solid', 'dashed'])
       + p9.scale_x_datetime(breaks=date_breaks('2 weeks'), labels=date_format('%b-%d'))
       + p9.labs(x='', y='KD cases [+0-3 days]', color='', linetype='')
       + p9.annotate(x='2011-04-23', y=4.8, geom='text', label='RÂ²=43.6%')
)).draw().savefig('../output/figures/clean_preds.pdf', bbox_inches='tight')
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_70_0.png" src="_images/metals_70_0.png"/>
</div>
</div>
</section>
<section id="treating-concentration-as-a-categorical-variable">
<h4>Treating concentration as a categorical variable<a class="headerlink" href="#treating-concentration-as-a-categorical-variable" title="Permalink to this headline">#</a></h4>
<p>Given the non-linearities we would expect on the effect of metals dose and likelihood of triggering the autoimmune response in vasculitis, it might be worth considering concentration as discrete categories. Letâ€™s take an initial look at how it would look:</p>
<section id="with-3-categories">
<h5>With 3 categories<a class="headerlink" href="#with-3-categories" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts)
 .assign(cat_concentration=lambda dd: pd.cut(dd.concentration, 3, precision=0))
  .pipe(lambda dd: p9.ggplot(dd) 
        + p9.aes('cat_concentration', 'kd_rolling_4') 
        + p9.geom_jitter(alpha=.7, width=.15)
        + p9.geom_boxplot(alpha=.7)
        + p9.labs(x='Concentration of Cluster 1 metals [ng/mÂ³]', y='KD cases [0 to 3 days]')
        + p9.theme(figure_size=(4, 3), axis_text_x=p9.element_text(rotation=45))
       )

)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_73_0.png" src="_images/metals_73_0.png"/>

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts)
 .assign(cat_concentration=lambda dd: pd.cut(dd.concentration, 3, precision=0))
 .pipe(lambda dd: smf.ols('kd_rolling_4 ~ cat_concentration', data=dd).fit().summary())
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>OLS Regression Results</caption>
<tbody><tr>
  <th>Dep. Variable:</th>      <td>kd_rolling_4</td>   <th>  R-squared:         </th> <td>   0.412</td>
</tr>
<tr>
  <th>Model:</th>                   <td>OLS</td>       <th>  Adj. R-squared:    </th> <td>   0.378</td>
</tr>
<tr>
  <th>Method:</th>             <td>Least Squares</td>  <th>  F-statistic:       </th> <td>   11.93</td>
</tr>
<tr>
  <th>Date:</th>             <td>jue, 02 jun 2022</td> <th>  Prob (F-statistic):</th> <td>0.000119</td>
</tr>
<tr>
  <th>Time:</th>                 <td>15:44:38</td>     <th>  Log-Likelihood:    </th> <td> -54.044</td>
</tr>
<tr>
  <th>No. Observations:</th>      <td>    37</td>      <th>  AIC:               </th> <td>   114.1</td>
</tr>
<tr>
  <th>Df Residuals:</th>          <td>    34</td>      <th>  BIC:               </th> <td>   118.9</td>
</tr>
<tr>
  <th>Df Model:</th>              <td>     2</td>      <th>                     </th>     <td> </td>   
</tr>
<tr>
  <th>Covariance Type:</th>      <td>nonrobust</td>    <th>                     </th>     <td> </td>   
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
                               <td></td>                                  <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P&gt;|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>                                                   <td>    1.5625</td> <td>    0.272</td> <td>    5.746</td> <td> 0.000</td> <td>    1.010</td> <td>    2.115</td>
</tr>
<tr>
  <th>cat_concentration[T.Interval(158.0, 250.0, closed='right')]</th> <td>    0.7102</td> <td>    0.426</td> <td>    1.667</td> <td> 0.105</td> <td>   -0.155</td> <td>    1.576</td>
</tr>
<tr>
  <th>cat_concentration[T.Interval(250.0, 341.0, closed='right')]</th> <td>    2.1375</td> <td>    0.438</td> <td>    4.875</td> <td> 0.000</td> <td>    1.246</td> <td>    3.029</td>
</tr>
</tbody></table>
<table class="simpletable">
<tbody><tr>
  <th>Omnibus:</th>       <td> 0.271</td> <th>  Durbin-Watson:     </th> <td>   1.265</td>
</tr>
<tr>
  <th>Prob(Omnibus):</th> <td> 0.873</td> <th>  Jarque-Bera (JB):  </th> <td>   0.096</td>
</tr>
<tr>
  <th>Skew:</th>          <td> 0.121</td> <th>  Prob(JB):          </th> <td>   0.953</td>
</tr>
<tr>
  <th>Kurtosis:</th>      <td> 2.944</td> <th>  Cond. No.          </th> <td>    3.37</td>
</tr>
</tbody></table><br/><br/>Notes:<br/>[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts)
 .assign(cat_concentration=lambda dd: pd.cut(dd.concentration, 3, precision=0))
 .pipe(lambda dd: pairwise_tukeyhsd(endog=dd['kd_rolling_4'],
                                    groups=dd['cat_concentration'],
                                    alpha=.05))
 .summary()
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<caption>Multiple Comparison of Means - Tukey HSD, FWER=0.05</caption>
<tbody><tr>
      <th>group1</th>         <th>group2</th>     <th>meandiff</th>  <th>p-adj</th>  <th>lower</th>   <th>upper</th> <th>reject</th>
</tr>
<tr>
   <td>(67.0, 158.0]</td> <td>(158.0, 250.0]</td>  <td>0.7102</td>  <td>0.2323</td> <td>-0.3336</td> <td>1.7541</td>  <td>False</td>
</tr>
<tr>
   <td>(67.0, 158.0]</td> <td>(250.0, 341.0]</td>  <td>2.1375</td>  <td>0.0001</td> <td>1.0631</td>  <td>3.2119</td>  <td>True</td> 
</tr>
<tr>
  <td>(158.0, 250.0]</td> <td>(250.0, 341.0]</td>  <td>1.4273</td>  <td>0.0135</td> <td>0.2628</td>  <td>2.5918</td>  <td>True</td> 
</tr>
</tbody></table></div></div>
</div>
</section>
</section>
<section id="test-for-3-categories">
<h4>Test for 3 categories<a class="headerlink" href="#test-for-3-categories" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>cluster_bins = (cluster_concentrations
 .loc[lambda dd: dd.cluster==1]
 .merge(kd_ts)
 .assign(cat_concentration=lambda dd: pd.cut(dd.concentration, 3, precision=0,
                                             labels=['Low', 'Medium', 'High']))
)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(cluster_bins
 .assign(cat_concentration=lambda dd: pd.cut(dd.concentration, 3, precision=0,
                                             labels=['Low\n(0-114]', 'Medium\n(114-227]', 'High\n(227-341]']))
  .pipe(lambda dd: p9.ggplot(dd) 
        + p9.aes('cat_concentration', 'kd_rolling_4') 
        + p9.geom_jitter(alpha=.7, width=.2, height=0)
        + p9.geom_boxplot(alpha=.6)
        + p9.labs(x='Concentration of Cluster 1 metals', y='KD cases [0 to 3 days]')
        + p9.theme(figure_size=(3, 3), axis_title=p9.element_text(size=9), panel_grid=p9.element_blank())
       ).draw().savefig('../output/figures/boxplots.pdf')

)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/metals_79_0.png" src="_images/metals_79_0.png"/>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>comp_lo_med_hi = dabest.load(cluster_bins,
                             x='cat_concentration',
                             y='kd_rolling_4',
                             idx=['Low', 'Medium', 'High'])
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bootstrap_test_results = (comp_lo_med_hi
                         .mean_diff
                         .results
                         .append(comp_med_hi.mean_diff.results)
                         
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(bootstrap_test_results
   .iloc[[0, 2, 1]]
 .explode('bootstraps')
 .assign(test_label=lambda dd: dd.test + ' - ' + dd.control)
 [['test_label', 'difference', 'bootstraps', 'pvalue_permutation']]
 .drop(columns='bootstraps')
 .drop_duplicates()
)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>test_label</th>
      <th>difference</th>
      <th>pvalue_permutation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>Medium - Low</td>
      <td>0.710227</td>
      <td>0.0940</td>
    </tr>
    <tr>
      <th>0</th>
      <td>High - Medium</td>
      <td>1.427273</td>
      <td>0.0124</td>
    </tr>
    <tr>
      <th>1</th>
      <td>High - Low</td>
      <td>2.137500</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>a = '#EEA236'
b = '#A94442'
c = '#5CB85C'
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>(bootstrap_test_results
 .iloc[[0, 2, 1]]
 .explode('bootstraps')
 .assign(test_label=lambda dd: dd.control + '-' + dd.test)
 .assign(bootstraps=lambda dd: dd.bootstraps.astype(float))
 [['test_label', 'difference', 'bootstraps', 'pvalue_permutation']]
 .assign(label=lambda dd: 
         dd.test_label +  ':\n $\mu_{diff}$ = ' + dd.difference.round(2).astype(str)
         + ', $p$ = ' + dd.pvalue_permutation.astype(str))
 .assign(label=lambda dd: pd.Categorical(dd.label, categories=dd.label.unique(), ordered=True))
 .pipe(lambda dd: p9.ggplot(dd)
       + p9.aes('bootstraps', fill='test_label')
       + p9.geom_density(bw=.2, alpha=.6)
       + p9.facet_wrap('label', ncol=1)
       + p9.labs(x='Bootstrapped Mean Diffs', y='')
       + p9.theme_void()
       + p9.theme(figure_size=(2, 3),
                  axis_text_x=p9.element_text(va='top', size=8),
                  axis_title_x=p9.element_text(size=8))
       + p9.scale_fill_manual([b, c, a])
       + p9.geom_vline(xintercept=0, linetype='dashed')
       + p9.guides(fill=False)
      ).draw().savefig('../output/figures/bs.pdf')
 )
</pre></div>
</div>
</div>
<div class="cell_output docutils container">

<img alt="_images/metals_84_1.png" src="_images/metals_84_1.png"/>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev" href="hysplit_trajectories.html" id="prev-link" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Modelling the air sources with HYSPLIT</p>
        </div>
    </a>
    <a class="right-next" href="weekly-cycle-figures-ang.html" id="next-link" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Sub-weekly cycle Figures</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Alejandro Fontal, Albert Navarro, Xavier RodÃ³<br/>
  
      Â© Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  
</body></html>