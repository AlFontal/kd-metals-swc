<!DOCTYPE html>
<html><head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Sub weekly cycle Figures â€” KD and metal rich aerosols</title>
    
  <link href="_static/css/theme.css" rel="stylesheet"/>
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet"/>

    
  <link href="_static/vendor/fontawesome/5.13.0/css/all.min.css" rel="stylesheet"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="" href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2" rel="preload" type="font/woff2"/>

    
      

    
    <link href="_static/pygments.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" rel="stylesheet" type="text/css"/>
    <link href="_static/togglebutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/copybutton.css" rel="stylesheet" type="text/css"/>
    <link href="_static/mystnb.css" rel="stylesheet" type="text/css"/>
    <link href="_static/sphinx-thebe.css" rel="stylesheet" type="text/css"/>
    <link href="_static/custom.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" rel="stylesheet" type="text/css"/>
    <link href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" rel="stylesheet" type="text/css"/>
    
  <link as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js" rel="preload"/>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script kind="utterances">

    var commentsRunWhenDOMLoaded = cb => {
    if (document.readyState != 'loading') {
        cb()
    } else if (document.addEventListener) {
        document.addEventListener('DOMContentLoaded', cb)
    } else {
        document.attachEvent('onreadystatechange', function() {
        if (document.readyState == 'complete') cb()
        })
    }
}

var addUtterances = () => {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://utteranc.es/client.js";
    script.async = "async";

    script.setAttribute("repo", "https://github.com/AlFontal/kd-metals-swc");
    script.setAttribute("issue-term", "pathname");
    script.setAttribute("theme", "github-light");
    script.setAttribute("label", "ðŸ’¬ comment");
    script.setAttribute("crossorigin", "anonymous");

    sections = document.querySelectorAll("div.section");
    if (sections !== null) {
        section = sections[sections.length-1];
        section.appendChild(script);
    }
}
commentsRunWhenDOMLoaded(addUtterances);
</script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link href="https://alfontal.github.io/kd-metals-swc/weekly-cycle-figures-ang.html" rel="canonical"/>
    <link href="_static/favicon.ico" rel="shortcut icon"/>
    <link href="genindex.html" rel="index" title="Index"/>
    <link href="search.html" rel="search" title="Search"/>
    <link href="metals.html" rel="prev" title="Metals in air masses and their effect on KD onset"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="None" name="docsearch:language"/>
    

    <!-- Google Analytics -->
    
  </head>
  <body data-offset="80" data-spy="scroll" data-target="#bd-toc-nav">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img alt="logo" class="logo" src="_static/logo.png"/>
      
      
      <h1 class="site-logo" id="site-title">KD and metal rich aerosols</h1>
      
    </a>
</div><form action="search.html" class="bd-search d-flex align-items-center" method="get">
  <i class="icon fas fa-search"></i>
  <input aria-label="Search this book..." autocomplete="off" class="form-control" id="search-input" name="q" placeholder="Search this book..." type="search"/>
</form><nav aria-label="Main" class="bd-links" id="bd-docs-nav">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   README
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Notebooks
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="hysplit_trajectories.html">
   HYSPLIT backtrajectories
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="metals.html">
   Chemistry and KD synchrony
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Sub-weekly Cycle Figures
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
<div>           
<hr/>
<a href="https://helical-itn.eu/">
<img src="https://helical-itn.eu/wp-content/uploads/2020/01/cropped-HELICAL_logo-3.png" width="200px"/>
</a>
<p></p>
<a href="https://www.isglobal.org/en/-/clima-y-salud">
<img src="https://www.isglobal.org/isglobal-new-theme/assets/images/isglobal/logo-isglobal-en.png" width="200px"/>
</a>

</div>

</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button aria-controls="navbar-menu" aria-expanded="true" aria-label="Toggle navigation" class="navbar-toggler ml-0" data-placement="bottom" data-target=".site-navigation" data-toggle="collapse" id="navbar-toggler" title="Toggle navigation" type="button">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button aria-label="Download this page" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/weekly-cycle-figures-ang.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Download source file" type="button">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" id="download-print" onclick="printPdf(this)" title="Print to PDF" type="button">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Connect with source repository" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button" href="https://github.com/AlFontal/kd-metals-swc"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Source repository" type="button"><i class="fab fa-github"></i>repository</button></a>
        <a class="issues-button" href="https://github.com/AlFontal/kd-metals-swc/issues/new?title=Issue%20on%20page%20%2Fweekly-cycle-figures-ang.html&amp;body=Your%20issue%20content%20here."><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Open an issue" type="button"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button aria-label="Fullscreen mode" class="btn btn-secondary topbarbtn" data-placement="bottom" data-toggle="tooltip" onclick="toggleFullScreen()" title="Fullscreen mode" type="button"><i class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button aria-label="Launch interactive content" class="btn btn-secondary topbarbtn" id="dropdown-buttons-trigger"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/AlFontal/kd-metals-swc/main?urlpath=tree/weekly-cycle-figures-ang.ipynb"><button class="btn btn-secondary topbarbtn" data-placement="left" data-toggle="tooltip" title="Launch Binder" type="button"><img alt="Interact on binder" class="binder-button-logo" src="_static/images/logo_binder.svg"/>Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav aria-label="Page" id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-and-install-packages">
     Load and install packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-4e">
   Figure 4E
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-5">
   Figure 5
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#figure-5a">
     Figure 5A
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#figure-5b">
     Figure 5B
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-6">
   Figure 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-4">
   Supplementary Figure 4
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-6">
   Supplementary Figure 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-7">
   Supplementary Figure 7
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supplementary-figure-7a">
     Supplementary Figure 7A
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supplementary-figure-7b">
     Supplementary Figure 7B
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-8">
   Supplementary Figure 8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-9">
   Supplementary Figure 9
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div class="row" id="main-content">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div class="onlyprint" id="jb-print-docs-body">
                <h1>Sub weekly cycle Figures</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preamble">
   Preamble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#load-and-install-packages">
     Load and install packages
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-4e">
   Figure 4E
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-5">
   Figure 5
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#figure-5a">
     Figure 5A
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#figure-5b">
     Figure 5B
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#figure-6">
   Figure 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-4">
   Supplementary Figure 4
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-6">
   Supplementary Figure 6
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-7">
   Supplementary Figure 7
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supplementary-figure-7a">
     Supplementary Figure 7A
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supplementary-figure-7b">
     Supplementary Figure 7B
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-8">
   Supplementary Figure 8
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#supplementary-figure-9">
   Supplementary Figure 9
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="sub-weekly-cycle-figures">
<h1>Sub weekly cycle Figures<a class="headerlink" href="#sub-weekly-cycle-figures" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">contents</span><span class="p">}</span>
<span class="p">:</span><span class="n">local</span><span class="p">:</span>
<span class="p">:</span><span class="n">depth</span><span class="p">:</span> <span class="mi">2</span>
</pre></div>
</div>
<div class="section" id="preamble">
<h2>Preamble<a class="headerlink" href="#preamble" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="load-and-install-packages">
<h3>Load and install packages<a class="headerlink" href="#load-and-install-packages" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Function for portable code</span>
<span class="n">insAndLoad</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">k</span> <span class="o">&lt;-</span> <span class="n">packages</span><span class="p">[</span><span class="o">!</span><span class="p">(</span><span class="n">packages</span> <span class="o">%in%</span> <span class="nf">installed.packages</span><span class="p">()[,</span><span class="s">"Package"</span><span class="p">])];</span>
  <span class="nf">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
  <span class="p">{</span><span class="nf">install.packages</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">repos</span><span class="o">=</span><span class="s">'https://cran.rstudio.com/'</span><span class="p">);}</span>
  
  <span class="nf">for</span><span class="p">(</span><span class="n">package_name</span> <span class="n">in</span> <span class="n">packages</span><span class="p">)</span>
  <span class="p">{</span><span class="nf">library</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span><span class="n">character.only</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">quietly</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">);}</span>
<span class="p">}</span>

<span class="c1">#Load or/and install needed packages</span>
<span class="nf">insAndLoad</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"progress"</span><span class="p">,</span><span class="s">"Hmisc"</span><span class="p">,</span><span class="s">"plot3D"</span><span class="p">,</span><span class="s">"purrr"</span><span class="p">,</span>
             <span class="s">"ggplot2"</span><span class="p">,</span> <span class="s">"tidyr"</span><span class="p">,</span> <span class="s">"dplyr"</span><span class="p">,</span> <span class="s">"readr"</span><span class="p">,</span> <span class="s">"tibble"</span><span class="p">,</span> 
             <span class="s">"zoo"</span><span class="p">,</span> <span class="s">"ggsci"</span><span class="p">,</span> <span class="s">"stringr"</span><span class="p">,</span><span class="s">"grid"</span><span class="p">,</span> <span class="s">"gridExtra"</span><span class="p">,</span>
             <span class="s">"reprex"</span><span class="p">,</span> <span class="s">"lubridate"</span><span class="p">,</span><span class="s">"caTools"</span><span class="p">,</span><span class="s">"TeachingDemos"</span><span class="p">,</span>
             <span class="s">"reshape2"</span><span class="p">,</span><span class="s">"caret"</span><span class="p">,</span><span class="s">"ggpubr"</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="figure-4e">
<h2>Figure 4E<a class="headerlink" href="#figure-4e" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="n">absc532_KD_Surf_6km</span> <span class="o">&lt;-</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/KD_absc532_mean_S-6km_daily.rds"</span><span class="p">)</span>

<span class="n">data_gg</span> <span class="o">&lt;-</span> <span class="n">absc532_KD_Surf_6km</span> <span class="o">%&gt;%</span>
    <span class="c1"># Add a column with all the years from the time series daily index</span>
    <span class="nf">mutate</span><span class="p">(</span><span class="n">Year</span> <span class="o">=</span> <span class="nf">year</span><span class="p">(</span><span class="n">Dates</span><span class="p">),</span>
           <span class="n">Month</span> <span class="o">=</span> <span class="nf">month</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="c1"># Group by the month</span>
    <span class="c1">#group_by(Month = month(Dates), Year) %&gt;%</span>
    <span class="nf">group_by</span><span class="p">(</span><span class="n">WeekDay</span> <span class="o">=</span> <span class="nf">wday</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">week_start</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span>
    <span class="c1"># Aggregate data monthly: mean, max or min?</span>
    <span class="nf">summarize_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="s">"absc532_TKO"</span><span class="p">,</span><span class="s">"KD_TKO"</span><span class="p">),</span> <span class="nf">list</span><span class="p">(</span><span class="o">~</span><span class="nf">mean</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
                                                   <span class="o">~</span><span class="nf">max</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">),</span>
                                                   <span class="o">~</span><span class="nf">min</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)))</span>


<span class="n">max_ld</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data_gg</span><span class="o">$</span><span class="n">KD_TKO_max</span><span class="p">)</span><span class="m">+1</span>
<span class="n">min_ld</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data_gg</span><span class="o">$</span><span class="n">KD_TKO_max</span><span class="p">)</span>
<span class="n">max_kd</span> <span class="o">&lt;-</span> <span class="nf">max</span><span class="p">(</span><span class="n">data_gg</span><span class="o">$</span><span class="n">absc532_TKO_max</span><span class="p">)</span><span class="o">*</span><span class="m">1E+6</span> <span class="o">-</span> <span class="m">1</span>
<span class="n">min_kd</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">data_gg</span><span class="o">$</span><span class="n">absc532_TKO_max</span><span class="p">)</span><span class="o">*</span><span class="m">1E+6</span> <span class="o">-</span> <span class="m">1</span>

<span class="c1"># plot coefficient</span>
<span class="n">ggCoeff_weekly</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">max_kd</span><span class="o">-</span><span class="n">min_kd</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">max_ld</span><span class="o">-</span><span class="n">min_ld</span><span class="p">)</span>
<span class="n">intercept</span> <span class="o">&lt;-</span> <span class="n">max_kd</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_ld</span><span class="o">*</span><span class="n">ggCoeff_weekly</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">data_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">WeekDay</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KD_TKO_max</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">absc532_TKO_max</span><span class="o">*</span><span class="m">1E+6</span> <span class="o">-</span> <span class="n">intercept</span><span class="p">)</span><span class="o">/</span><span class="n">ggCoeff_weekly</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">ggCoeff_weekly</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">"absc532 [/Mm/sr]"</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'Week day'</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">'KD cases'</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"dodgerblue"</span><span class="p">),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"bottom"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/weekly-cycle-figures-ang_3_0.png" src="_images/weekly-cycle-figures-ang_3_0.png"/>
</div>
</div>
</div>
<div class="section" id="figure-5">
<h2>Figure 5<a class="headerlink" href="#figure-5" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="figure-5a">
<h3>Figure 5A<a class="headerlink" href="#figure-5a" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="n">Corr_tb_TKO_m</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Corr</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span>
                        <span class="n">Dates</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span> <span class="nf">names</span><span class="p">(</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span> <span class="p">)</span> <span class="p">)</span> <span class="o">%&gt;%</span>
                 <span class="c1"># Select correlations over 0.5</span>
                 <span class="c1">#filter(Corr &gt;= 0.45 ) %&gt;%</span>
                 <span class="nf">filter</span><span class="p">(</span><span class="n">Corr</span> <span class="o">&gt;=</span> <span class="m">0</span> <span class="p">)</span> <span class="o">%&gt;%</span>
                 <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"month"</span><span class="p">))</span> <span class="o">%&gt;%</span>
                 <span class="nf">summarise</span><span class="p">(</span><span class="n">absc532Corr</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">Corr</span><span class="p">)))</span><span class="o">%&gt;%</span>
                 <span class="nf">mutate</span><span class="p">(</span><span class="n">absc532Corr</span> <span class="o">=</span> <span class="nf">runmean</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">absc532Corr</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="m">3</span> <span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="s">"C"</span><span class="p">,</span> <span class="n">endrule</span> <span class="o">=</span> <span class="s">"mean"</span><span class="p">,</span><span class="n">align</span> <span class="o">=</span> <span class="s">"center"</span><span class="p">))</span>
                 <span class="c1">#summarise(absc532Corr=mean(Corr, na.rm=TRUE))</span>
<span class="n">KD_file_m</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Japan</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">Japan</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-01"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),]</span> <span class="o">%&gt;%</span>
             <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"month"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">summarise</span><span class="p">(</span><span class="n">KDcases</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">Japan</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">KDcases</span> <span class="o">=</span> <span class="nf">runmean</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">KDcases</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="m">3</span> <span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="s">"C"</span><span class="p">,</span> <span class="n">endrule</span> <span class="o">=</span> <span class="s">"mean"</span><span class="p">,</span><span class="n">align</span> <span class="o">=</span> <span class="s">"center"</span><span class="p">))</span>

<span class="n">KD_2010_16_gg</span> <span class="o">&lt;-</span> <span class="nf">right_join</span><span class="p">(</span><span class="n">Corr_tb_TKO_m</span><span class="p">,</span> <span class="n">KD_file_m</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">"Months"</span><span class="p">)</span>

<span class="n">ggKDCorrCoeff_m</span> <span class="o">&lt;-</span> <span class="m">2</span><span class="o">/</span><span class="m">5</span> <span class="c1">#16/130</span>
<span class="n">ggKDCorrInter_m</span> <span class="o">&lt;-</span> <span class="m">-100</span> <span class="c1">#-1120/13</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">KD_2010_16_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Months</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KDcases</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">absc532Corr</span><span class="o">-</span><span class="n">ggKDCorrInter_m</span><span class="p">)</span><span class="o">/</span><span class="n">ggKDCorrCoeff_m</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">),</span> 
              <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">ggKDCorrCoeff_m</span><span class="o">+</span> <span class="n">ggKDCorrInter_m</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">"PM arrival with 3.5d cycle"</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'Year'</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">'KD cases'</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"dodgerblue"</span><span class="p">),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span>
          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/weekly-cycle-figures-ang_6_0.png" src="_images/weekly-cycle-figures-ang_6_0.png"/>
</div>
</div>
</div>
<div class="section" id="figure-5b">
<h3>Figure 5B<a class="headerlink" href="#figure-5b" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">8</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">IRdisplay</span><span class="p">)</span>
<span class="n">Dates_gen</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">d</span><span class="p">){</span>
                      <span class="n">st_d</span> <span class="o">&lt;-</span> <span class="n">d</span> <span class="o">%&gt;%</span> <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">"-01-01"</span><span class="p">)</span>
                      <span class="n">end_d</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">d</span><span class="m">+1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">"-01-01"</span><span class="p">)</span>
                      <span class="n">sq_d</span> <span class="o">&lt;-</span> <span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="n">st_d</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">end_d</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">-1</span><span class="p">)</span>
                      <span class="nf">return</span><span class="p">(</span><span class="n">sq_d</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">Dates_KD</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">2011</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">),</span><span class="n">Dates_gen</span><span class="p">)</span>
<span class="n">KD_list</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">Dates_KD</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">k</span><span class="p">){</span> <span class="n">KD_file</span><span class="p">[</span><span class="n">KD_file</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="n">k</span><span class="p">,]</span> <span class="o">%&gt;%</span>   <span class="c1">#select 1 year period</span>
                                     <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"Japan"</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1">#select KD cases for all Japan</span>
                                     <span class="nf">mutate_all</span><span class="p">(</span><span class="n">as.numeric</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1">#transform to numeric</span>
                                     <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="p">{</span><span class="s">'names&lt;-'</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">}</span> <span class="c1">#name values with dates</span>
                                   <span class="p">})</span>
<span class="n">KD_file</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
     <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span>
<span class="n">KD_list</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">Dates_KD</span><span class="p">,</span> <span class="nf">function</span><span class="p">(</span><span class="n">k</span><span class="p">){</span> <span class="n">KD_file</span><span class="p">[</span><span class="n">KD_file</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="n">k</span><span class="p">,]</span> <span class="o">%&gt;%</span>   <span class="c1">#select 1 year period</span>
                                 <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"Japan"</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1">#select KD cases for all Japan</span>
                                 <span class="nf">mutate_all</span><span class="p">(</span><span class="n">as.numeric</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="c1">#transform to numeric</span>
                                 <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="p">{</span><span class="s">'names&lt;-'</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">}</span> <span class="c1">#name values with dates</span>
                               <span class="p">})</span>
<span class="n">KD_maxima</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">KD_list</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">){</span>  <span class="n">a</span><span class="p">[</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="nf">emp.hpd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">conf</span> <span class="o">=</span> <span class="m">0.90</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="p">]</span>  <span class="p">})</span> <span class="o">%&gt;%</span> <span class="nf">unlist</span><span class="p">()</span> 
<span class="n">KD_2010_2016_mx</span> <span class="o">&lt;-</span> <span class="nf">names</span><span class="p">(</span><span class="n">KD_maxima</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">as.Date</span><span class="p">()</span> <span class="o">%&gt;%</span> 
                <span class="n">.</span><span class="p">[</span><span class="n">.</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-01"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">)]</span> <span class="o">%&gt;%</span>
                <span class="nf">month</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">cut</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">table</span><span class="p">()</span>
<span class="n">Corr_pref</span> <span class="o">&lt;-</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/Corr84_OW"</span><span class="p">)</span>
<span class="n">jp_pref</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Toyama"</span><span class="p">,</span><span class="s">"Tsukuba"</span><span class="p">,</span><span class="s">"Tokyo"</span><span class="p">)</span>
<span class="n">datalist</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="nf">seq_along</span><span class="p">(</span><span class="n">jp_pref</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Corr_surf</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">Corr_pref</span><span class="p">,</span> <span class="n">`[[`</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">%&gt;%</span>
             <span class="nf">lapply</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">`[[`</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span>
             <span class="n">.</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">.</span> <span class="o">&gt;=</span> <span class="m">0.5</span><span class="p">)]</span> <span class="o">%&gt;%</span> 
             <span class="c1">#Extract dates</span>
             <span class="nf">names</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.Date</span><span class="p">()</span> <span class="o">%&gt;%</span>
             <span class="nf">month</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">cut</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">table</span><span class="p">()</span>

    <span class="n">Corr_oPBL</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">Corr_pref</span><span class="p">,</span> <span class="n">`[[`</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">%&gt;%</span>
             <span class="nf">lapply</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">`[[`</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span>
             <span class="n">.</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">.</span> <span class="o">&gt;=</span> <span class="m">0.5</span><span class="p">)]</span> <span class="o">%&gt;%</span> 
             <span class="c1">#Extract dates</span>
             <span class="nf">names</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.Date</span><span class="p">()</span> <span class="o">%&gt;%</span>
             <span class="nf">month</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">cut</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">12</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">table</span><span class="p">()</span>
<span class="c1">#Divide the values between the years analized to get the year taxa</span>
    <span class="n">Corr_KD_absc532</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">KD_2010_2016_mx</span> <span class="o">=</span> <span class="n">KD_2010_2016_mx</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">KD_2010_2016_mx</span><span class="p">),</span>
                         <span class="n">absc532_surf_35d</span> <span class="o">=</span> <span class="n">Corr_surf</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">Corr_surf</span><span class="p">),</span>
                         <span class="n">absc532_oPBL_35d</span> <span class="o">=</span> <span class="n">Corr_oPBL</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">Corr_oPBL</span><span class="p">),</span>
                         <span class="n">Month</span> <span class="o">=</span> <span class="nf">factor</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Jan"</span><span class="p">,</span> <span class="s">"Feb"</span><span class="p">,</span> <span class="s">"Mar"</span><span class="p">,</span> <span class="s">"Apr"</span><span class="p">,</span>
                                                        <span class="s">"May"</span><span class="p">,</span> <span class="s">"Jun"</span><span class="p">,</span> <span class="s">"Jul"</span><span class="p">,</span> <span class="s">"Aug"</span><span class="p">,</span>
                                                        <span class="s">"Sep"</span><span class="p">,</span> <span class="s">"Oct"</span><span class="p">,</span> <span class="s">"Nov"</span><span class="p">,</span> <span class="s">"Dec"</span><span class="p">),</span>
                                       <span class="n">ordered</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="p">)</span>   <span class="o">%&gt;%</span> 
                    <span class="nf">pivot_longer</span><span class="p">(</span>
                        <span class="n">cols</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"KD_2010_2016_mx"</span><span class="p">,</span> <span class="s">"absc532_surf_35d"</span><span class="p">,</span> <span class="s">"absc532_oPBL_35d"</span><span class="p">),</span>
                        <span class="n">values_to</span> <span class="o">=</span> <span class="s">"value"</span><span class="p">,</span>
                        <span class="n">names_to</span> <span class="o">=</span> <span class="s">"variable"</span><span class="p">,</span>
                        <span class="n">names_repair</span> <span class="o">=</span> <span class="s">"minimal"</span><span class="p">)</span> <span class="o">%&gt;%</span>
                    <span class="nf">mutate</span><span class="p">(</span><span class="n">station</span><span class="o">=</span><span class="n">jp_pref</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
     <span class="n">datalist</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">Corr_KD_absc532</span>   
<span class="p">}</span>
<span class="n">Corr_KD_absc532</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">rbind</span><span class="p">,</span> <span class="n">datalist</span><span class="p">)</span>
<span class="n">Corr_KD_absc532</span><span class="o">$</span><span class="n">variable</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span> <span class="n">Corr_KD_absc532</span><span class="o">$</span><span class="n">variable</span><span class="p">,</span> 
    <span class="n">levels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"KD_2010_2016_mx"</span><span class="p">,</span> <span class="s">"absc532_surf_35d"</span><span class="p">,</span> <span class="s">"absc532_oPBL_35d"</span><span class="p">))</span>
<span class="n">Corr_KD_absc532</span><span class="o">$</span><span class="n">station</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span> <span class="n">Corr_KD_absc532</span><span class="o">$</span><span class="n">station</span><span class="p">,</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Toyama"</span><span class="p">,</span><span class="s">"Tsukuba"</span><span class="p">,</span><span class="s">"Tokyo"</span><span class="p">))</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">Corr_KD_absc532</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Month</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">variable</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">variable</span><span class="p">),</span><span class="n">position</span> <span class="o">=</span> <span class="s">"fill"</span><span class="p">)</span> <span class="o">+</span>   
  <span class="nf">geom_bar</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="s">"dodge"</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s">"identity"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">"Ratio"</span><span class="p">)</span> <span class="o">+</span> 
  <span class="nf">theme</span><span class="p">(</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
    <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
    <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">),</span>
    <span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
    <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
    <span class="n">legend.position</span><span class="o">=</span><span class="s">"top"</span><span class="p">,</span>
    <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"black"</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">"white"</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  <span class="nf">facet_grid</span><span class="p">(</span><span class="n">station</span><span class="o">~</span><span class="n">.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Don't know how to automatically pick scale for object of type table. Defaulting to continuous.
</pre></div>
</div>
<img alt="_images/weekly-cycle-figures-ang_8_1.png" src="_images/weekly-cycle-figures-ang_8_1.png"/>
</div>
</div>
</div>
</div>
<div class="section" id="figure-6">
<h2>Figure 6<a class="headerlink" href="#figure-6" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">14</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="c1"># KD data daily -&gt; weekly</span>
<span class="n">KD_file_w</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="c1"># first week starts on the 3rd of January for 2010</span>
             <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-03"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),]</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Japan</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">Japan</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"week"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">summarise</span><span class="p">(</span><span class="n">KDcases</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">Japan</span><span class="p">))</span>
<span class="c1"># head(KD_file)         </span>
<span class="c1"># Wind Spedd daily -&gt; weekly</span>
<span class="n">Uwind</span> <span class="o">&lt;-</span> <span class="nf">read.table</span><span class="p">(</span><span class="s">"data/uwnd_YEAR1.1970_YEAR2.2016_LON.138.75_LAT.37.1422.txt"</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="n">Vwind</span> <span class="o">&lt;-</span> <span class="nf">read.table</span><span class="p">(</span><span class="s">"data/vwnd_YEAR1.1970_YEAR2.2016_LON.138.75_LAT.37.1422.txt"</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
<span class="n">WSwind_w</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span> <span class="n">ws</span> <span class="o">=</span> <span class="nf">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="n">Uwind</span><span class="o">$</span><span class="n">V4</span><span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Vwind</span><span class="o">$</span><span class="n">V4</span><span class="p">)</span><span class="o">^</span><span class="m">2</span> <span class="p">),</span>
                    <span class="n">Dates</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span> <span class="nf">paste</span><span class="p">(</span><span class="n">Uwind</span><span class="o">$</span><span class="n">V3</span><span class="p">,</span><span class="n">Uwind</span><span class="o">$</span><span class="n">V2</span><span class="p">,</span><span class="n">Uwind</span><span class="o">$</span><span class="n">V1</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">"-"</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">%&gt;%</span>
            <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-03"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),]</span> <span class="o">%&gt;%</span>
            <span class="nf">group_by</span><span class="p">(</span><span class="n">Month</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"week"</span><span class="p">))</span> <span class="o">%&gt;%</span>
            <span class="nf">summarise</span><span class="p">(</span><span class="n">SumWs</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>

<span class="c1">#PM arrival with 3.5 days cycle</span>
<span class="n">Jap_lidar</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"TKB"</span><span class="p">,</span><span class="s">"TKO"</span><span class="p">,</span><span class="s">"TYM"</span><span class="p">,</span><span class="s">"SEO"</span><span class="p">)</span>

<span class="c1">#Dates with 84d cycle</span>
<span class="n">Corr_tw84</span> <span class="o">&lt;-</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/Corr_tw84"</span><span class="p">)</span>
<span class="n">Corr_tw84_c</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="nf">seq_along</span><span class="p">(</span><span class="n">Jap_lidar</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">pref</span><span class="p">){</span>
  <span class="n">Corr_tw84</span> <span class="o">%&gt;%</span>
    <span class="c1">#First lvl of stations</span>
    <span class="nf">lapply</span><span class="p">(</span> <span class="n">.</span><span class="p">,</span> <span class="s">'[['</span><span class="p">,</span> <span class="n">pref</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span>
     <span class="c1"># Remove extreme correlations</span>
    <span class="nf">ifelse</span><span class="p">(</span><span class="n">.</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="n">.</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">ifelse</span><span class="p">(</span><span class="n">.</span><span class="o">==</span><span class="m">-1</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="n">.</span><span class="p">)</span>
<span class="p">})</span>
<span class="nf">names</span><span class="p">(</span><span class="n">Corr_tw84_c</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">Jap_lidar</span>
<span class="n">Corr_tb_TKO_w</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Corr</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span>
                        <span class="n">Dates</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span> <span class="nf">names</span><span class="p">(</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span> <span class="p">)</span> <span class="p">)</span> <span class="o">%&gt;%</span>
                 <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"week"</span><span class="p">))</span> <span class="o">%&gt;%</span>
                 <span class="nf">summarise</span><span class="p">(</span><span class="n">SumCorr</span><span class="o">=</span><span class="nf">mean</span><span class="p">(</span><span class="n">Corr</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="nf">na.omit</span><span class="p">()</span>

<span class="c1"># Plot x axis names</span>
<span class="n">dts</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">2010</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">)</span> <span class="c1">#Study period [years]</span>
<span class="n">m.names</span> <span class="o">&lt;-</span> <span class="nf">as.vector</span><span class="p">(</span> <span class="nf">outer</span><span class="p">(</span><span class="n">month.abb</span><span class="p">,</span> <span class="nf">str_sub</span><span class="p">(</span><span class="n">dts</span><span class="p">,</span><span class="n">start</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="p">,</span> <span class="n">paste0</span><span class="p">)</span> <span class="p">)</span> <span class="c1">#Names for months+year</span>
<span class="c1">#Plot</span>
<span class="c1">#Add extra space to right margin of plot within frame</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">))</span> 
<span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>

<span class="c1">#1.KD cases Japan (Y1)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">KD_file_w</span><span class="o">$</span><span class="n">KDcases</span><span class="p">,</span><span class="n">type</span><span class="o">=</span><span class="s">"l"</span><span class="p">,</span><span class="n">xaxt</span><span class="o">=</span><span class="s">"n"</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">150</span><span class="p">,</span><span class="m">500</span><span class="p">),</span> <span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">cex.lab</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>
     <span class="n">lwd</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">ylab</span><span class="o">=</span><span class="s">"KD cases"</span><span class="p">,</span><span class="n">xlab</span><span class="o">=</span><span class="s">""</span><span class="p">,</span> <span class="c1">#ylim=c(-2.5,3.5),</span>
     <span class="c1">#main="Association of Japan KD cases with PM arrival in Tokyo per week (2010-2016)"</span>
     <span class="p">)</span>
<span class="nf">axis</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="n">at</span><span class="o">=</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">WSwind_w</span><span class="o">$</span><span class="n">SumWs</span><span class="p">),</span><span class="m">4.36</span><span class="p">),</span><span class="n">labels</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="n">las</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="c1">#2.PM arrival with 3.5days cycle (Y2)</span>
<span class="nf">par</span><span class="p">(</span><span class="n">new</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">Corr_tb_TKO_w</span><span class="o">$</span><span class="n">SumCorr</span><span class="p">,</span><span class="n">type</span> <span class="o">=</span> <span class="s">"l"</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">ylim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.2</span><span class="p">,</span><span class="m">0.55</span><span class="p">),</span>
     <span class="n">bty</span> <span class="o">=</span> <span class="s">"n"</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="nf">axis</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="n">at</span><span class="o">=</span><span class="nf">pretty</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">Corr_tb_TKO_w</span><span class="o">$</span><span class="n">SumCorr</span><span class="p">)),</span> <span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>
     <span class="n">col</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span><span class="n">col.ticks</span> <span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span><span class="n">col.axis</span> <span class="o">=</span> <span class="s">"dodgerblue"</span> <span class="p">)</span>
<span class="nf">mtext</span><span class="p">(</span><span class="s">"PM arrival SWC"</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="m">2.5</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span><span class="n">cex</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="c1">#3.WindSpeed</span>
<span class="nf">par</span><span class="p">(</span><span class="n">new</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">WSwind_w</span><span class="o">$</span><span class="n">SumWs</span><span class="p">,</span><span class="n">type</span> <span class="o">=</span> <span class="s">"l"</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">cex.lab</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>
     <span class="n">bty</span> <span class="o">=</span> <span class="s">"n"</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"firebrick"</span><span class="p">,</span><span class="n">lwd</span><span class="o">=</span><span class="m">3</span><span class="p">)</span>
<span class="nf">axis</span><span class="p">(</span><span class="m">4</span><span class="p">,</span><span class="n">at</span><span class="o">=</span><span class="nf">pretty</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">WSwind_w</span><span class="o">$</span><span class="n">SumWs</span><span class="p">)),</span> <span class="n">line</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>
     <span class="n">col</span><span class="o">=</span><span class="s">"firebrick"</span><span class="p">,</span><span class="n">col.ticks</span> <span class="o">=</span><span class="s">"firebrick"</span><span class="p">,</span><span class="n">col.axis</span> <span class="o">=</span> <span class="s">"firebrick"</span><span class="p">)</span>
<span class="nf">mtext</span><span class="p">(</span><span class="s">"Wind Speed [m/s]"</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="m">6.5</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"firebrick"</span><span class="p">,</span><span class="n">cex</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>

<span class="n">absc532_mtx</span> <span class="o">&lt;-</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/absc532_TKO_MonthlyProfile.RDS"</span><span class="p">)</span>
<span class="n">height_a</span> <span class="o">&lt;-</span><span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/absc532_TKO_Altitude.RDS"</span><span class="p">)</span>

<span class="c1">#Select altitude</span>
<span class="n">h120</span> <span class="o">&lt;-</span> <span class="nf">which.min</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">height_a</span><span class="m">-0.12</span><span class="p">))</span> <span class="c1">#due to lidar resolution above 120m</span>
<span class="n">h10000</span> <span class="o">&lt;-</span> <span class="nf">which.min</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">height_a</span><span class="m">-10</span><span class="p">))</span> <span class="c1">#10km as maxima</span>
<span class="n">h120_10000</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="o">=</span><span class="n">h120</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="n">h10000</span><span class="p">,</span><span class="n">by</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

<span class="n">absc532_mtx_a</span> <span class="o">&lt;-</span> <span class="n">absc532_mtx</span><span class="p">[,</span><span class="n">h120_10000</span><span class="p">]</span>

<span class="c1">#Names for months+year</span>
<span class="c1">#m.names &lt;- as.vector( outer(month.abb, str_sub(dts,start = 3) , paste0) ) </span>
<span class="n">plotMonths</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="m">2010</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
<span class="n">plotMonths</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mar</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">2.2</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span>
<span class="nf">image2D</span><span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="n">absc532_mtx_a</span><span class="o">*</span><span class="m">1E+06</span><span class="p">,</span>
        <span class="n">clim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">3</span><span class="p">),</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">height_a</span><span class="p">[</span><span class="n">h120_10000</span><span class="p">],</span>
        <span class="n">xlab</span><span class="o">=</span><span class="s">""</span><span class="p">,</span><span class="n">xaxt</span><span class="o">=</span><span class="s">"n"</span><span class="p">,</span> <span class="n">cex.axis</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">cex.lab</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">font</span><span class="o">=</span><span class="m">2</span><span class="p">,</span>
        <span class="n">ylab</span><span class="o">=</span><span class="s">"Altitude [km]"</span><span class="p">,</span><span class="n">NAcol</span> <span class="o">=</span> <span class="s">"grey"</span><span class="p">,</span>
        <span class="n">colkey</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">cex.axis</span><span class="o">=</span><span class="m">2</span><span class="p">)</span>
        <span class="c1">#main="Lidar Tokyo mean absc532 per month (2010-2016)"</span>
<span class="p">)</span>
<span class="nf">axis</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">length.out</span> <span class="o">=</span> <span class="m">84</span><span class="p">),</span><span class="n">labels</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span><span class="n">las</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="m">-2</span><span class="p">)</span>
<span class="nf">axis</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="n">length.out</span> <span class="o">=</span> <span class="m">84</span><span class="p">)[</span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">84</span><span class="p">,</span><span class="m">12</span><span class="p">)],</span>
     <span class="n">labels</span> <span class="o">=</span> <span class="n">plotMonths</span><span class="p">,</span><span class="c1">#[seq(1,84,4)],</span>
     <span class="n">cex.axis</span> <span class="o">=</span> <span class="m">2</span> <span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="m">-2</span><span class="p">)</span>
<span class="nf">mtext</span><span class="p">(</span><span class="s">"absc532 [/Mm/sr]"</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="m">4</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">cex</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">mtext</span><span class="p">(</span><span class="s">"Time [month]"</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="m">1</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">cex</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><style>
.list-inline {list-style: none; margin:0; padding: 0}
.list-inline>li {display: inline-block}
.list-inline>li:not(:last-child)::after {content: "\00b7"; padding: 0 .5ex}
</style>
<ol class="list-inline"><li>2010</li><li>2011</li><li>2012</li><li>2013</li><li>2014</li><li>2015</li><li>2016</li></ol>
</div><img alt="_images/weekly-cycle-figures-ang_10_1.png" src="_images/weekly-cycle-figures-ang_10_1.png"/>
</div>
</div>
</div>
<div class="section" id="supplementary-figure-4">
<h2>Supplementary Figure 4<a class="headerlink" href="#supplementary-figure-4" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>
<span class="c1"># KD data daily -&gt; yearly</span>
<span class="n">KD_file_y</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Japan</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">Japan</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"year"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">summarise</span><span class="p">(</span><span class="n">KDcases</span><span class="o">=</span><span class="nf">max</span><span class="p">(</span><span class="n">Japan</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>

<span class="c1"># Compute OW-SDC for KD daily data at s=7 and lag=7d+-1d</span>
<span class="n">KD_file_d</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">mutate</span><span class="p">(</span><span class="n">Japan</span> <span class="o">=</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">Japan</span><span class="p">))</span> <span class="c1">#%&gt;%</span>
             <span class="c1">#.[.$Dates %in% seq(as.Date("2010-01-01"),as.Date("2010-03-31"),by="day"),]</span>

<span class="c1"># Empty list for correlation values</span>
<span class="n">Corr_pref7</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>

<span class="c1"># Dates list</span>
<span class="n">Dates_00</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1970-01-01"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1971-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1970-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1972-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1971-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1973-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1972-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1974-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1973-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1975-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1974-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1976-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1975-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1977-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1976-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1978-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1977-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1979-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1978-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1980-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1979-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1981-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1980-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1982-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1981-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1983-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1982-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1984-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1983-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1985-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1984-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1986-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1985-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1987-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1986-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1988-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1987-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1989-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1988-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1990-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1989-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1991-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1990-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1992-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1991-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1993-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1992-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1994-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1993-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1995-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1994-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1996-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1995-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1997-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1996-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1998-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1997-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1999-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1998-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2000-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"1999-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2001-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2000-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2002-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2001-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2003-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2002-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2004-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2003-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2005-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2004-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2006-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2005-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2007-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2006-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2008-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2007-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2009-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2008-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2009-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2011-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2012-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2011-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2013-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2012-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2014-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2013-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2015-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2014-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-01-14"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">),</span>
<span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2015-12-25"</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1">#Progress bar</span>
<span class="n">pb</span> <span class="o">&lt;-</span> <span class="nf">txtProgressBar</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">Dates_00</span><span class="p">),</span> <span class="n">initial</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span><span class="n">style</span><span class="o">=</span><span class="m">3</span><span class="p">)</span> 

<span class="nf">for</span><span class="p">(</span><span class="n">dd</span> <span class="n">in</span> <span class="nf">seq_along</span><span class="p">(</span><span class="n">Dates_00</span><span class="p">)){</span>
    <span class="n">Dates_0</span> <span class="o">&lt;-</span> <span class="n">Dates_00</span><span class="p">[[</span><span class="n">dd</span><span class="p">]]</span>

    <span class="c1">##########</span>
    <span class="c1">#OW-SDC  #</span>
    <span class="c1">##########</span>
    <span class="c1"># Timer series</span>
    <span class="n">ts_lead</span> <span class="o">&lt;-</span> <span class="n">KD_file_d</span> <span class="o">%&gt;%</span> 
               <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="n">Dates_0</span><span class="p">,]</span> <span class="o">%&gt;%</span>
               <span class="nf">select</span><span class="p">(</span><span class="n">Japan</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">as.vector</span>
    <span class="n">ts_sub</span>  <span class="o">&lt;-</span> <span class="n">KD_file_d</span> <span class="o">%&gt;%</span> 
               <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="n">Dates_0</span><span class="p">,]</span> <span class="o">%&gt;%</span>
               <span class="nf">select</span><span class="p">(</span><span class="n">Japan</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">as.vector</span>
    <span class="c1">#Window size</span>
    <span class="n">sw</span> <span class="o">&lt;-</span> <span class="m">7</span>
    <span class="c1">#Lag from the main diagonal</span>
    <span class="n">sl</span> <span class="o">&lt;-</span> <span class="m">7</span>

    <span class="c1">#Al possible windows of size sw</span>
    <span class="n">k1</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">ts_lead</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
    <span class="n">k2</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="o">=</span><span class="m">1</span><span class="p">,</span><span class="n">to</span><span class="o">=</span><span class="nf">length</span><span class="p">(</span><span class="n">ts_sub</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>

    <span class="n">ts_v1_wf</span> <span class="o">&lt;-</span> <span class="nf">sapply</span><span class="p">(</span><span class="n">k1</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>  <span class="n">ts_lead</span><span class="p">[</span><span class="n">x</span><span class="o">:</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">sw</span><span class="p">)]</span> <span class="p">})</span>
    <span class="n">ts_v2_wf</span> <span class="o">&lt;-</span> <span class="nf">sapply</span><span class="p">(</span><span class="n">k2</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>  <span class="n">ts_sub</span><span class="p">[</span><span class="n">x</span><span class="o">:</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">sw</span><span class="p">)]</span> <span class="p">})</span>

    <span class="c1">#All values for real windows until first NA</span>
    <span class="n">ts_v1_wf_cln</span> <span class="o">&lt;-</span> <span class="n">ts_v1_wf</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">dim</span><span class="p">(</span><span class="n">ts_v1_wf</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="o">-</span><span class="n">sw</span><span class="p">)]</span>
    <span class="n">ts_v2_wf_cln</span> <span class="o">&lt;-</span> <span class="n">ts_v2_wf</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">dim</span><span class="p">(</span><span class="n">ts_v2_wf</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="o">-</span><span class="n">sw</span><span class="p">)]</span>

    <span class="c1">#Correlation matrix with respective p-value with spearman method</span>
    <span class="n">cor.SDC</span> <span class="o">&lt;-</span> <span class="nf">rcorr</span><span class="p">(</span><span class="n">ts_v1_wf_cln</span><span class="p">,</span><span class="n">ts_v2_wf_cln</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="s">"spearman"</span><span class="p">)</span>
    <span class="n">cor.mtx</span> <span class="o">&lt;-</span> <span class="n">cor.SDC</span><span class="o">$</span><span class="n">r</span><span class="p">[(</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">r</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="o">/</span><span class="m">2+1</span><span class="p">)</span><span class="o">:</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">r</span><span class="p">)[</span><span class="m">2</span><span class="p">],</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">r</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="o">/</span><span class="m">2</span><span class="p">)]</span>             
    <span class="n">cor.p.v</span> <span class="o">&lt;-</span> <span class="n">cor.SDC</span><span class="o">$</span><span class="n">P</span><span class="p">[(</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">P</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span><span class="o">/</span><span class="m">2+1</span><span class="p">)</span><span class="o">:</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">P</span><span class="p">)[</span><span class="m">2</span><span class="p">],</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">dim</span><span class="p">(</span><span class="n">cor.SDC</span><span class="o">$</span><span class="n">P</span><span class="p">)[</span><span class="m">1</span><span class="p">]</span><span class="o">/</span><span class="m">2</span><span class="p">)]</span>
    <span class="n">cor.SDC</span> <span class="o">&lt;-</span> <span class="kc">NULL</span> <span class="c1">#Clean memory</span>
    <span class="n">cor.mtx</span><span class="p">[</span><span class="n">cor.p.v</span> <span class="o">&gt;</span> <span class="m">0.05</span><span class="p">]</span> <span class="o">&lt;-</span> <span class="kc">NA</span> <span class="c1">#Significance test applied</span>

    <span class="c1"># A companion matrix that indicates how "off" a diagonal is:</span>
    <span class="n">delta</span> <span class="o">&lt;-</span> <span class="nf">row</span><span class="p">(</span><span class="n">cor.mtx</span><span class="p">)</span> <span class="o">-</span> <span class="nf">col</span><span class="p">(</span><span class="n">cor.mtx</span><span class="p">)</span>

    <span class="c1">#Reverse matrix since image.plot() reverses the image (matrix values)  </span>
    <span class="n">mat1</span> <span class="o">&lt;-</span> <span class="nf">apply</span><span class="p">(</span><span class="n">cor.mtx</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="n">rev</span><span class="p">)</span>

    <span class="c1">#Save cor.mtx dimensions and clean memory</span>
    <span class="n">dim_cor</span> <span class="o">&lt;-</span> <span class="nf">dim</span><span class="p">(</span><span class="n">cor.mtx</span><span class="p">)</span>
    <span class="n">cor.p.v</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>

    <span class="c1">#Use split to group on these values</span>
    <span class="n">diagonals</span> <span class="o">&lt;-</span> <span class="nf">split</span><span class="p">(</span><span class="n">cor.mtx</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
    <span class="n">cor.mtx</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>

    <span class="c1">#Selected area for correlation analysis</span>
    <span class="n">area_sel</span> <span class="o">&lt;-</span> <span class="m">1</span>
    <span class="n">disc.line</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">((</span><span class="n">sl</span><span class="o">-</span><span class="n">area_sel</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">sl</span><span class="o">+</span><span class="n">area_sel</span><span class="p">))</span>
    <span class="n">area_diags</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">disc.line</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">z</span><span class="p">){</span><span class="n">diagonals</span><span class="p">[[</span><span class="n">z</span> <span class="o">+</span> <span class="n">dim_cor</span><span class="p">[</span><span class="m">1</span><span class="p">]]]</span> <span class="p">})</span>
    <span class="n">diagonals</span> <span class="o">&lt;-</span> <span class="kc">NULL</span>

    <span class="c1">#Cut diagonals to have the same length</span>
    <span class="c1">#Dates has an extra length due to the selection of the lag</span>
    <span class="c1">#before and after the date (2*sl) and the extra due to SDC (sw)</span>
    <span class="n">diag_len</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">Dates_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sw</span> <span class="o">-</span> <span class="m">2</span><span class="o">*</span><span class="n">sl</span>

    <span class="n">cut_diags</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>

    <span class="nf">for </span><span class="p">(</span><span class="n">cc</span> <span class="n">in</span> <span class="nf">seq_along</span><span class="p">(</span><span class="n">area_diags</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">#For off diagonals greater than the lag sl we insert NAs</span>
      <span class="c1">#at the beginning and cut for diag_len to remove the extra tail</span>
      <span class="nf">if</span><span class="p">((</span><span class="n">sl</span><span class="o">-</span><span class="n">disc.line</span><span class="p">[</span><span class="n">cc</span><span class="p">])</span><span class="o">&lt;</span><span class="m">0</span><span class="p">){</span>
        <span class="n">cut_diags</span><span class="p">[[</span><span class="n">cc</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">rep</span><span class="p">(</span><span class="kc">NA</span><span class="p">,</span><span class="nf">abs</span><span class="p">(</span><span class="n">sl</span><span class="o">-</span><span class="n">disc.line</span><span class="p">[</span><span class="n">cc</span><span class="p">])),</span><span class="n">area_diags</span><span class="p">[[</span><span class="n">cc</span><span class="p">]])[</span><span class="m">1</span><span class="o">:</span><span class="n">diag_len</span><span class="p">]</span>
      <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
        <span class="c1">#For off diagonals lesser than the lag sl we remove the first</span>
        <span class="c1">#positions and select accordingly to diag_len</span>
        <span class="n">cut_diags</span><span class="p">[[</span><span class="n">cc</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">area_diags</span><span class="p">[[</span><span class="n">cc</span><span class="p">]][</span><span class="nf">seq</span><span class="p">(</span><span class="n">sl</span><span class="o">-</span><span class="n">disc.line</span><span class="p">[</span><span class="n">cc</span><span class="p">]</span><span class="m">+1</span><span class="p">,</span>
                                                <span class="n">diag_len</span><span class="o">+</span><span class="n">sl</span><span class="o">-</span><span class="n">disc.line</span><span class="p">[</span><span class="n">cc</span><span class="p">],</span><span class="m">1</span><span class="p">)]</span>
      <span class="p">}</span>                                      

    <span class="p">}</span>

    <span class="n">area_max_corr</span> <span class="o">&lt;-</span>  <span class="nf">do.call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span><span class="n">cut_diags</span><span class="p">)</span> <span class="o">%&gt;%</span> 
      <span class="c1">#Substract main diagonal values equal to 1</span>
      <span class="nf">ifelse</span><span class="p">(</span><span class="n">.</span><span class="o">==</span> <span class="m">1</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="n">.</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="nf">ifelse</span><span class="p">(</span><span class="n">.</span><span class="o">==</span> <span class="m">-1</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="n">.</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="nf">apply</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">invec</span><span class="p">){</span>
        <span class="n">na.pct</span> <span class="o">&lt;-</span> <span class="nf">sum</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">invec</span><span class="p">))</span><span class="o">/</span><span class="nf">length</span><span class="p">(</span><span class="n">invec</span><span class="p">)</span>
        <span class="nf">if </span><span class="p">(</span><span class="n">na.pct</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">return</span><span class="p">(</span><span class="kc">NA</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">else</span> <span class="p">{</span>
          <span class="c1"># return(invec[which.max(abs(invec))])</span>
          <span class="nf">return</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">invec</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>
        <span class="p">}</span>
      <span class="p">})</span>

    <span class="n">startDateInd</span> <span class="o">&lt;-</span> <span class="n">sl</span> <span class="o">+</span> <span class="m">1</span>
    <span class="n">finalDateInd</span> <span class="o">&lt;-</span> <span class="nf">length</span><span class="p">(</span><span class="n">Dates_0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sw</span> <span class="o">-</span> <span class="n">sl</span>

    <span class="n">KD_file_weeklyCycle</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Dates</span> <span class="o">=</span> <span class="n">Dates_0</span><span class="p">[</span><span class="n">startDateInd</span><span class="o">:</span><span class="n">finalDateInd</span><span class="p">],</span>
                                  <span class="n">KD_corr</span> <span class="o">=</span> <span class="n">area_max_corr</span><span class="p">)</span> 
    <span class="n">Corr_pref7</span><span class="p">[[</span><span class="n">dd</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">KD_file_weeklyCycle</span>
    <span class="nf">setTxtProgressBar</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span><span class="n">dd</span><span class="p">)</span>
<span class="p">}</span>    
    

<span class="n">KD_corr_y</span> <span class="o">&lt;-</span> <span class="nf">bind_rows</span><span class="p">(</span><span class="n">Corr_pref7</span><span class="p">)</span> <span class="o">%&gt;%</span>
             <span class="nf">filter</span><span class="p">(</span><span class="n">KD_corr</span> <span class="o">&gt;</span> <span class="m">0.5</span><span class="p">)</span> <span class="o">%&gt;%</span>
             <span class="nf">group_by</span><span class="p">(</span><span class="n">Months</span><span class="o">=</span><span class="nf">floor_date</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="s">"year"</span><span class="p">))</span> <span class="o">%&gt;%</span>
             <span class="nf">summarise</span><span class="p">(</span><span class="n">KD_corr</span><span class="o">=</span><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">KD_corr</span><span class="p">)))</span>
<span class="n">KD_gg</span> <span class="o">&lt;-</span> <span class="nf">right_join</span><span class="p">(</span><span class="n">KD_corr_y</span><span class="p">,</span><span class="n">KD_file_y</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">"Months"</span><span class="p">)</span>
<span class="n">ggKDCorrCoeff</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="c1">#(3/14)*1E-4</span>
<span class="n">ggKDCorrInter</span> <span class="o">&lt;-</span> <span class="m">0</span> <span class="c1">#23/35</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">KD_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Months</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KDcases</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">KD_corr</span><span class="o">-</span><span class="n">ggKDCorrInter</span><span class="p">)</span><span class="o">/</span><span class="n">ggKDCorrCoeff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"red"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">ggKDCorrCoeff</span><span class="o">+</span> <span class="n">ggKDCorrInter</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">"SWC days [counts]"</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'Time [year]'</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">'KD cases'</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"red"</span><span class="p">),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span>
          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  |======================================================================| 100%
</pre></div>
</div>
<img alt="_images/weekly-cycle-figures-ang_12_1.png" src="_images/weekly-cycle-figures-ang_12_1.png"/>
</div>
</div>
</div>
<div class="section" id="supplementary-figure-6">
<h2>Supplementary Figure 6<a class="headerlink" href="#supplementary-figure-6" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="m">-1</span><span class="p">)</span>

<span class="n">AeroIntrDays</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">DatesH</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2010-01-01 00:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                <span class="n">to</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2016-12-31 23:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                <span class="n">by</span><span class="o">=</span><span class="s">"hour"</span><span class="p">),</span>
                   <span class="n">TKB</span> <span class="o">=</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TKB"</span><span class="p">]],</span>
                   <span class="n">TKO</span> <span class="o">=</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TKO"</span><span class="p">]],</span>
                   <span class="n">TYM</span> <span class="o">=</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TYM"</span><span class="p">]],</span>
                <span class="p">)</span> <span class="o">%&gt;%</span>
                <span class="nf">filter</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">DatesH</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2011-01-01"</span><span class="p">)</span> <span class="p">)</span> <span class="o">%&gt;%</span>
                <span class="c1"># Extract days with aerosol entries</span>
                <span class="nf">group_by</span><span class="p">(</span><span class="n">Dates</span> <span class="o">=</span> <span class="nf">floor_date</span><span class="p">(</span><span class="n">DatesH</span><span class="p">,</span> <span class="s">"day"</span><span class="p">))</span> <span class="o">%&gt;%</span>
                <span class="nf">summarize_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="s">"TKB"</span><span class="p">,</span><span class="s">"TKO"</span><span class="p">,</span><span class="s">"TYM"</span><span class="p">),</span> <span class="nf">list</span><span class="p">(</span><span class="o">~</span><span class="nf">max</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)))</span> <span class="o">%&gt;%</span>
                <span class="nf">ungroup</span><span class="p">()</span> <span class="o">%&gt;%</span>
                <span class="c1"># Filter for correlations over 0.5</span>
                <span class="nf">mutate_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="s">"Dates"</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="nf">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="m">0</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)})</span>

<span class="c1"># KD data days</span>
<span class="n">Dates_gen</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">d</span><span class="p">){</span>
  <span class="n">st_d</span> <span class="o">&lt;-</span> <span class="n">d</span> <span class="o">%&gt;%</span> <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">"-01-01"</span><span class="p">)</span>
  <span class="n">end_d</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">d</span><span class="m">+1</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">as.character</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">"-01-01"</span><span class="p">)</span>
  <span class="n">sq_d</span> <span class="o">&lt;-</span> <span class="nf">seq.Date</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span><span class="n">st_d</span><span class="p">),</span><span class="n">to</span> <span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">end_d</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"days"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">-1</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">sq_d</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">Dates_KD</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="m">2011</span><span class="p">,</span><span class="m">2016</span><span class="p">,</span><span class="m">1</span><span class="p">),</span> <span class="n">Dates_gen</span><span class="p">)</span>
<span class="c1"># Import KD daily data</span>
<span class="n">KD_fileDays</span> <span class="o">&lt;-</span> <span class="n">KD_file_ms</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
               <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
               <span class="nf">rename</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"TKB"</span><span class="o">=</span><span class="s">"8"</span><span class="p">,</span> <span class="s">"TKO"</span><span class="o">=</span><span class="s">"13"</span><span class="p">,</span> <span class="s">"TYM"</span><span class="o">=</span><span class="s">"16"</span><span class="p">))</span> <span class="o">%&gt;%</span>
               <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span><span class="n">TKB</span><span class="p">,</span><span class="n">TKO</span><span class="p">,</span><span class="n">TYM</span><span class="p">))</span> <span class="o">%&gt;%</span>
               <span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="o">!</span><span class="n">Dates</span><span class="p">,</span> <span class="n">as.numeric</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2011-01-01"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),]</span>
<span class="c1"># Keep correlations above this value</span>
<span class="n">corrFilter</span> <span class="o">&lt;-</span> <span class="m">0.5</span>
<span class="c1"># Empty list to store data for plot</span>
<span class="n">lag_KDAero_list</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="c1"># LIDAR stations</span>
<span class="n">jplidar</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"TKB"</span><span class="p">,</span><span class="s">"TKO"</span><span class="p">,</span><span class="s">"TYM"</span><span class="p">)</span>
<span class="nf">for </span><span class="p">(</span><span class="n">jp</span> <span class="n">in</span> <span class="n">jplidar</span><span class="p">){</span>
<span class="c1">#lapply computes a function for all the elements in the list</span>
<span class="c1">#operator %&gt;% indicates a pipe, which tells R to take the value of that which is to the left and pass it to the right as an argument</span>
<span class="c1">#operatior %in% ensures matching conditions from a vector, in this case dates (Dates_KD)</span>
<span class="n">KD_list</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">Dates_KD</span><span class="p">,</span> 
                  <span class="nf">function</span><span class="p">(</span><span class="n">k</span><span class="p">){</span> 
                      <span class="n">KD_fileDays</span><span class="p">[</span><span class="n">KD_fileDays</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="n">k</span><span class="p">,]</span> <span class="o">%&gt;%</span>   <span class="c1">#select 1 year period</span>
                      <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">jp</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="c1">#select KD cases for all prefecture</span>
                      <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="p">{</span><span class="s">'names&lt;-'</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="p">}</span> <span class="c1">#name values with dates</span>
        <span class="p">})</span>
<span class="n">KDmax_Days</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">KD_list</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">){</span>  <span class="n">a</span><span class="p">[</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="nf">emp.hpd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">conf</span> <span class="o">=</span> <span class="m">0.97</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="p">]</span>  <span class="p">})</span> <span class="o">%&gt;%</span> 
              <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">names</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.Date</span><span class="p">()</span>
    
<span class="n">KDmax_Days_Test_A</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">KD_list</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">){</span>  <span class="n">a</span><span class="p">[</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="nf">emp.hpd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">conf</span> <span class="o">=</span> <span class="m">0.95</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="p">]</span>  <span class="p">})</span> <span class="o">%&gt;%</span> 
                       <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">table</span><span class="p">()</span>
<span class="n">KDmax_Days_Test_B</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">KD_list</span><span class="p">,</span><span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">){</span>  <span class="n">a</span><span class="p">[</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="nf">emp.hpd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">conf</span> <span class="o">=</span> <span class="m">0.97</span><span class="p">)[</span><span class="m">2</span><span class="p">]</span> <span class="p">]</span>  <span class="p">})</span> <span class="o">%&gt;%</span> 
                       <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">table</span><span class="p">()</span>
<span class="c1">#print(KDmax_Days_Test_A)</span>
<span class="c1">#print(KDmax_Days_Test_B)</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">"Number of KD maxima (0.95) for "</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="s">": "</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">KDmax_Days</span><span class="p">))</span> <span class="p">)</span>
<span class="n">AeroTKO_Days</span> <span class="o">&lt;-</span> <span class="n">AeroIntrDays</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"Dates"</span><span class="p">,</span> <span class="n">jp</span><span class="p">))</span> <span class="o">%&gt;%</span> 
                <span class="nf">mutate_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="s">"Dates"</span><span class="p">)),</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span><span class="nf">replace</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">corrFilter</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)})</span> <span class="o">%&gt;%</span> <span class="nf">drop_na</span><span class="p">()</span> <span class="o">%&gt;%</span> 
                <span class="nf">select</span><span class="p">(</span><span class="n">Dates</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.Date</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">"Number of PM entry days for "</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="s">": "</span><span class="p">,</span> <span class="nf">length</span><span class="p">(</span><span class="n">AeroTKO_Days</span><span class="p">))</span> <span class="p">)</span>

<span class="c1">#Lag between KD maxima and absc532 oPBL</span>
<span class="n">diff_KD_Aero</span> <span class="o">&lt;-</span> <span class="nf">sapply</span><span class="p">(</span><span class="n">KDmax_Days</span><span class="p">,</span> 
                       <span class="nf">function</span><span class="p">(</span><span class="n">l</span><span class="p">){</span>  <span class="c1">#Differece between days</span>
                         <span class="n">dft</span> <span class="o">&lt;-</span> <span class="nf">difftime</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">AeroTKO_Days</span><span class="p">,</span><span class="n">units</span> <span class="o">=</span> <span class="s">"days"</span><span class="p">)</span> 
                         <span class="c1">#Selects first absolute minimum with the sign since</span>
                         <span class="c1">#in case of draw it select the first in order, the negative.</span>
                         <span class="n">dft</span><span class="p">[</span><span class="nf">which.min</span><span class="p">(</span> <span class="nf">abs</span><span class="p">(</span> <span class="n">dft</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
                       <span class="p">})</span>
    
<span class="c1">#print(tibble(KDmax_dates = KDmax_Days, Lag = diff_KD_Aero) %&gt;% filter(Lag == 5) )</span>
<span class="c1"># Random dates comparision    </span>
<span class="n">rnd_list</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="nf">for</span><span class="p">(</span><span class="n">rd</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="m">1000</span><span class="p">){</span>
<span class="n">rndDates</span> <span class="o">&lt;-</span> <span class="nf">sample</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2011-01-01"</span><span class="p">),</span> <span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-31"</span><span class="p">),</span> <span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),</span> <span class="nf">length</span><span class="p">(</span><span class="n">AeroTKO_Days</span><span class="p">))</span>
<span class="c1">#Lag between KD maxima and absc532 oPBL</span>
<span class="n">diff_KD_Rnd</span> <span class="o">&lt;-</span> <span class="nf">sapply</span><span class="p">(</span><span class="n">KDmax_Days</span><span class="p">,</span> 
                       <span class="nf">function</span><span class="p">(</span><span class="n">l</span><span class="p">){</span>  <span class="c1">#Differece between days</span>
                         <span class="n">dft</span> <span class="o">&lt;-</span> <span class="nf">difftime</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">rndDates</span><span class="p">,</span><span class="n">units</span> <span class="o">=</span> <span class="s">"days"</span><span class="p">)</span> 
                         <span class="c1">#Selects first absolute minimum with the sign since</span>
                         <span class="c1">#in case of draw it selects the first in order, the negative.</span>
                         <span class="n">dft</span><span class="p">[</span><span class="nf">which.min</span><span class="p">(</span> <span class="nf">abs</span><span class="p">(</span> <span class="n">dft</span> <span class="p">)</span> <span class="p">)</span> <span class="p">]</span>
                       <span class="p">})</span>
<span class="n">rnd_list</span><span class="p">[[</span><span class="n">rd</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">table</span><span class="p">(</span><span class="nf">factor</span><span class="p">(</span><span class="n">diff_KD_Rnd</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="m">-60</span><span class="o">:</span><span class="m">60</span><span class="p">))</span> <span class="o">%&gt;%</span> 
                  <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">lag_KDAero_pref</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span> <span class="n">Real</span> <span class="o">=</span> <span class="nf">table</span><span class="p">(</span><span class="nf">factor</span><span class="p">(</span><span class="n">diff_KD_Aero</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="m">-60</span><span class="o">:</span><span class="m">60</span><span class="p">))</span> <span class="p">,</span>
                           <span class="n">Days</span> <span class="o">=</span> <span class="nf">names</span><span class="p">(</span><span class="n">Real</span><span class="p">),</span>
                           <span class="n">Rnd</span> <span class="o">=</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">rnd_list</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">rowMeans</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
                           <span class="n">Station</span> <span class="o">=</span> <span class="n">jp</span>
                          <span class="p">)</span>

<span class="n">lag_KDAero_list</span><span class="p">[[</span><span class="n">jp</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">lag_KDAero_pref</span>
<span class="p">}</span>


<span class="c1"># Bind KD into a single dataset</span>
<span class="n">lag_KDAero</span> <span class="o">&lt;-</span> <span class="nf">bind_rows</span><span class="p">(</span><span class="n">lag_KDAero_list</span><span class="p">,</span><span class="n">.id</span> <span class="o">=</span> <span class="s">"BindVar"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">BindVar</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">melt</span><span class="p">(</span><span class="n">id.vars</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">"Days"</span><span class="p">,</span><span class="s">"Station"</span><span class="p">))</span>

<span class="c1">#head(lag_KDAero)</span>

<span class="n">dailyLag_gg</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">lag_KDAero</span><span class="p">,</span> 
       <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">Days</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span> <span class="o">+</span>  
  <span class="c1">#geom_histogram(alpha=0.6, position="identity",binwidth = 1) + </span>
  <span class="c1">#scale_colour_manual(values=c(Lag="limegreen"))+</span>
 <span class="nf">geom_bar</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">subset</span><span class="p">(</span><span class="n">lag_KDAero</span><span class="p">,</span><span class="n">variable</span> <span class="o">==</span> <span class="s">"Real"</span><span class="p">),</span> <span class="n">stat</span><span class="o">=</span><span class="s">"identity"</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s">"identity"</span><span class="p">)</span> <span class="o">+</span>
 <span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nf">subset</span><span class="p">(</span><span class="n">lag_KDAero</span><span class="p">,</span><span class="n">variable</span> <span class="o">==</span> <span class="s">"Rnd"</span><span class="p">),</span> <span class="n">colour</span><span class="o">=</span><span class="s">"cornflowerblue"</span><span class="p">)</span> <span class="o">+</span> 
 <span class="c1">#geom_line(alpha=0.6) +</span>

 <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"Lag [days]"</span><span class="p">,</span>
     <span class="n">y</span><span class="o">=</span><span class="s">"PM arrival SWC frequency"</span><span class="p">,</span>
     <span class="n">color</span><span class="o">=</span><span class="s">"Lag"</span><span class="c1">#,</span>
     <span class="c1">#title='Lag between KD maxima (0.97) and PM entry days',</span>
     <span class="c1">#subtitle="Station: KDmax | PM entry days. TKB: 162 | 166. TKO: 109 | 165. TYM: 243 | 74"</span>
     
     <span class="p">)</span> <span class="o">+</span> 
  <span class="nf">theme</span><span class="p">(</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
    <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
    <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">),</span>
    <span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
    <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
    <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span><span class="p">,</span>
      <span class="n">axis.title.y.left</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"firebrick2"</span><span class="p">),</span>
    <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"black"</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">"white"</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  <span class="nf">facet_grid</span><span class="p">(</span><span class="n">Station</span><span class="o">~</span><span class="n">.</span><span class="p">)</span>
<span class="n">dailyLag_gg</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] "Number of KD maxima (0.95) for TKB: 162"
[1] "Number of PM entry days for TKB: 166"
[1] "Number of KD maxima (0.95) for TKO: 109"
[1] "Number of PM entry days for TKO: 165"
[1] "Number of KD maxima (0.95) for TYM: 243"
[1] "Number of PM entry days for TYM: 74"
</pre></div>
</div>
<img alt="_images/weekly-cycle-figures-ang_14_1.png" src="_images/weekly-cycle-figures-ang_14_1.png"/>
</div>
</div>
</div>
<div class="section" id="supplementary-figure-7">
<h2>Supplementary Figure 7<a class="headerlink" href="#supplementary-figure-7" title="Permalink to this headline">Â¶</a></h2>
<div class="section" id="supplementary-figure-7a">
<h3>Supplementary Figure 7A<a class="headerlink" href="#supplementary-figure-7a" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">LidarStations_35d</span> <span class="o">&lt;-</span> <span class="nf">read_rds</span><span class="p">(</span><span class="s">"data/LidarSatations_35d.RDS"</span><span class="p">)</span>
<span class="c1"># 1.1 Select dates from TW between absc532 from 4.3-6km and surface with 3.5days cycle from hourly data.</span>
<span class="c1"># When does the cycle 3.5days reach the surface in a particle variable such as absc532?</span>
<span class="n">Corr_tw84</span> <span class="o">&lt;-</span> <span class="nf">readRDS</span><span class="p">(</span><span class="s">"data/Corr_tw84"</span><span class="p">)</span>
<span class="c1"># LIDAR stations</span>
<span class="n">Jap_lidar</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"TKB"</span><span class="p">,</span><span class="s">"TKO"</span><span class="p">,</span><span class="s">"TYM"</span><span class="p">)</span>
<span class="n">Corr_tw84_c</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="nf">seq_along</span><span class="p">(</span><span class="n">Jap_lidar</span><span class="p">),</span> <span class="nf">function</span><span class="p">(</span><span class="n">pref</span><span class="p">){</span>
  <span class="n">Corr_tw84</span> <span class="o">%&gt;%</span>
    <span class="c1">#First lvl of stations</span>
    <span class="nf">lapply</span><span class="p">(</span> <span class="n">.</span><span class="p">,</span> <span class="s">'[['</span><span class="p">,</span> <span class="n">pref</span><span class="p">)</span> <span class="o">%&gt;%</span>
    <span class="nf">unlist</span><span class="p">()</span> <span class="o">%&gt;%</span>
    <span class="nf">ifelse</span><span class="p">(</span><span class="n">.</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="kc">NA</span><span class="p">,</span><span class="n">.</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1"># Name list with station names</span>
<span class="nf">names</span><span class="p">(</span><span class="n">Corr_tw84_c</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="n">Jap_lidar</span>
<span class="n">lidStat_List</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">lidStat_List_rnd</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="c1"># Select specific altitude layers from absc532 vertical profile plot</span>
<span class="n">altSlice_st</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="s">"TKB"</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">"V"</span><span class="p">,</span><span class="nf">seq</span><span class="p">(</span><span class="m">67</span><span class="p">,</span><span class="m">100</span><span class="p">)),</span>
                    <span class="s">"TKO"</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">"V"</span><span class="p">,</span><span class="nf">seq</span><span class="p">(</span><span class="m">50</span><span class="p">,</span><span class="m">83</span><span class="p">)),</span>
                    <span class="s">"TYM"</span><span class="o">=</span><span class="nf">paste0</span><span class="p">(</span><span class="s">"V"</span><span class="p">,</span><span class="nf">seq</span><span class="p">(</span><span class="m">100</span><span class="p">,</span><span class="m">133</span><span class="p">))</span>
                    <span class="p">)</span>
<span class="nf">for</span><span class="p">(</span><span class="n">st</span> <span class="n">in</span> <span class="n">Jap_lidar</span><span class="p">){</span>
  <span class="n">Corr_dates</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Corr</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="n">st</span><span class="p">]],</span>
                       <span class="n">DatesH</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2010-01-01 00:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                    <span class="n">to</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2016-12-31 23:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                    <span class="n">by</span><span class="o">=</span><span class="s">"hour"</span><span class="p">)</span> <span class="p">)</span><span class="o">%&gt;%</span>
                <span class="c1"># Select correlations over 0.5</span>
                <span class="nf">filter</span><span class="p">(</span><span class="n">Corr</span> <span class="o">&gt;</span> <span class="m">0.5</span> <span class="p">)</span>
  <span class="n">lidStatVar</span> <span class="o">&lt;-</span> <span class="n">LidarStations_35d</span><span class="p">[[</span><span class="n">st</span><span class="p">]][[</span><span class="s">"absc1064"</span><span class="p">]]</span>
  <span class="n">lidStatVar_F</span> <span class="o">&lt;-</span> <span class="n">lidStatVar</span><span class="p">[</span><span class="n">lidStatVar</span><span class="o">$</span><span class="n">DatesH</span> <span class="o">%in%</span> <span class="n">Corr_dates</span><span class="o">$</span><span class="n">DatesH</span><span class="p">,]</span> <span class="o">%&gt;%</span>
                  <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">DatesH</span><span class="p">,</span> <span class="n">DatesD</span><span class="p">))</span> <span class="o">%&gt;%</span>
                  <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">altSlice_st</span><span class="p">[[</span><span class="n">st</span><span class="p">]]))</span> <span class="o">%&gt;%</span>
                  <span class="nf">replace</span><span class="p">(</span><span class="n">.</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span> <span class="o">%&gt;%</span>
                  <span class="nf">replace</span><span class="p">(</span><span class="n">.</span> <span class="o">&lt;</span> <span class="m">0</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span> <span class="o">%&gt;%</span>
                  <span class="c1">#mutate(meanValue=rowMeans(na.rm = TRUE, across(starts_with("V")))) %&gt;%</span>
                  <span class="c1">#select(c(meanValue)) %&gt;%</span>
                  <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="n">.</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">.</span><span class="p">)]</span>
  
  <span class="n">lidStat_List</span><span class="p">[[</span><span class="n">st</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">lidStatVar_F</span>
  
  <span class="c1"># Random Dates for comparison</span>
  <span class="n">rng_lid_list</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
  <span class="nf">for</span><span class="p">(</span><span class="n">rg</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="m">400</span><span class="p">){</span>
    <span class="c1"># Random Dates for comparison</span>
    <span class="n">RandomDates</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2010-01-01 00:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                       <span class="n">to</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2016-12-31 23:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                       <span class="n">by</span><span class="o">=</span><span class="s">"hour"</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="nf">sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">.</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">Corr_dates</span><span class="o">$</span><span class="n">DatesH</span><span class="p">),</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>
    
    <span class="n">lidStatVar_F_rnd</span> <span class="o">&lt;-</span> <span class="n">lidStatVar</span><span class="p">[</span><span class="n">lidStatVar</span><span class="o">$</span><span class="n">DatesH</span> <span class="o">%in%</span> <span class="n">RandomDates</span><span class="p">,]</span> <span class="o">%&gt;%</span>
      <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">DatesH</span><span class="p">,</span> <span class="n">DatesD</span><span class="p">))</span> <span class="o">%&gt;%</span>
      <span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">altSlice_st</span><span class="p">[[</span><span class="n">st</span><span class="p">]]))</span> <span class="o">%&gt;%</span>
      <span class="nf">replace</span><span class="p">(</span><span class="n">.</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="nf">replace</span><span class="p">(</span><span class="n">.</span> <span class="o">&lt;</span> <span class="m">0</span><span class="p">,</span> <span class="kc">NA</span><span class="p">)</span> <span class="o">%&gt;%</span>
      <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> 
    <span class="n">rng_lid_list</span><span class="p">[[</span><span class="n">rg</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">lidStatVar_F_rnd</span>
  <span class="p">}</span>
  <span class="n">rng_vect</span> <span class="o">&lt;-</span> <span class="nf">do.call</span><span class="p">(</span><span class="n">cbind</span><span class="p">,</span> <span class="n">rng_lid_list</span><span class="p">)</span> <span class="o">%&gt;%</span>
              <span class="nf">rowMeans</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span>
              <span class="nf">t</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">as.vector</span><span class="p">()</span> <span class="o">%&gt;%</span>
              <span class="n">.</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">.</span><span class="p">)]</span>
  <span class="n">lidStat_List_rnd</span><span class="p">[[</span><span class="n">st</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">rng_vect</span>

<span class="p">}</span>
<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="m">-1</span><span class="p">)</span>

<span class="n">lidStat_gg_real</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">lidStat_List</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">lidStat_gg_real</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span><span class="s">"Station"</span><span class="p">)</span>
<span class="n">lidStat_gg_real</span><span class="o">$</span><span class="n">variable</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="s">"real"</span><span class="p">,</span><span class="nf">dim</span><span class="p">(</span><span class="n">lidStat_gg_real</span><span class="p">)[</span><span class="m">1</span><span class="p">])</span>

<span class="n">lidStat_gg_rnd</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">lidStat_List_rnd</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">lidStat_gg_rnd</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"value"</span><span class="p">,</span><span class="s">"Station"</span><span class="p">)</span>
<span class="n">lidStat_gg_rnd</span><span class="o">$</span><span class="n">variable</span> <span class="o">&lt;-</span> <span class="nf">rep</span><span class="p">(</span><span class="s">"rnd"</span><span class="p">,</span><span class="nf">dim</span><span class="p">(</span><span class="n">lidStat_gg_rnd</span><span class="p">)[</span><span class="m">1</span><span class="p">])</span>

<span class="n">lidStat_gg</span> <span class="o">&lt;-</span> <span class="nf">rbind</span><span class="p">(</span><span class="n">lidStat_gg_real</span><span class="p">,</span><span class="n">lidStat_gg_rnd</span><span class="p">)</span>

<span class="nf">ggplot</span><span class="p">(</span><span class="n">lidStat_gg</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">value</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">variable</span><span class="p">))</span> <span class="o">+</span> 
  <span class="nf">geom_density</span><span class="p">()</span> <span class="o">+</span> 
  <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">xlim</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0.4</span><span class="p">)</span> <span class="o">+</span>
<span class="c1">#ylim(0,1) +</span>
  <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">"dep532 (S/P)"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
    <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
    <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">),</span>
    <span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
    <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
    <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span><span class="p">,</span>
    <span class="n">strip.background</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"black"</span><span class="p">,</span><span class="n">fill</span><span class="o">=</span><span class="s">"white"</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  <span class="nf">facet_grid</span><span class="p">(</span><span class="nf">factor</span><span class="p">(</span><span class="n">Station</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">'TYM'</span><span class="p">,</span><span class="s">'TKB'</span><span class="p">,</span><span class="s">'TKO'</span><span class="p">))</span><span class="o">~</span><span class="n">.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/weekly-cycle-figures-ang_17_0.png" src="_images/weekly-cycle-figures-ang_17_0.png"/>
</div>
</div>
</div>
<div class="section" id="supplementary-figure-7b">
<h3>Supplementary Figure 7B<a class="headerlink" href="#supplementary-figure-7b" title="Permalink to this headline">Â¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">LidarStations_35d</span> <span class="o">&lt;-</span> <span class="nf">read_rds</span><span class="p">(</span><span class="s">"data/LidarSatations_35d.RDS"</span><span class="p">)</span>

<span class="c1"># Select Lidar station variables and dates with 3.5d cycle</span>
<span class="c1"># Empty list to fill</span>
<span class="n">LidarVars_35c</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">LidarVars_RNG</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">BAE_list</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">absc532_listS</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
<span class="n">rngReps</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="c1"># When does the cycle 3.5days reach the surface in a particle variable such as absc532?</span>

<span class="c1"># Function to compute the bootstrap interval:</span>
<span class="n">bsci</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">B</span><span class="p">){</span>
  <span class="n">bstrap</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">()</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">B</span><span class="p">){</span>
    <span class="n">bstrap</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="n">bstrap</span><span class="p">,</span><span class="nf">mean</span><span class="p">(</span><span class="nf">sample</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">replace</span><span class="o">=</span><span class="bp">T</span><span class="p">),</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>
  <span class="p">}</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">bstrap</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">for </span><span class="p">(</span><span class="n">ldStat</span> <span class="n">in</span> <span class="n">Jap_lidar</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="c1"># Select only dates with 3.5d cycle: extract hours lagged 1 </span>
  <span class="c1"># day below the diagonal with correlations above 0.5 in a TW (s=84h)</span>
  <span class="n">Corr_absc532_d</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Corr</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span>
                           <span class="n">DatesH</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2010-01-01 00:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                       <span class="n">to</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2016-12-31 23:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                                       <span class="n">by</span><span class="o">=</span><span class="s">"hour"</span><span class="p">)</span> <span class="p">)</span> <span class="o">%&gt;%</span>
                    <span class="c1"># Select correlations over 0.5</span>
                    <span class="nf">filter</span><span class="p">(</span><span class="n">Corr</span> <span class="o">&gt;</span> <span class="m">0.5</span> <span class="p">)</span>
                    <span class="c1">#mutate(DatesH = ymd_h( format(as.POSIXct(Dates),format="%Y-%m-%d  %H")  )  ) %&gt;%</span>
                   
  
  <span class="n">LidarVars_Stat</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">LidarStations_35d</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span> <span class="nf">function</span><span class="p">(</span><span class="n">ldVar</span><span class="p">){</span>
                      <span class="n">ldVar</span><span class="p">[</span><span class="n">ldVar</span><span class="o">$</span><span class="n">DatesH</span> <span class="o">%in%</span> <span class="n">Corr_absc532_d</span><span class="o">$</span><span class="n">DatesH</span><span class="p">,]</span>  
                     <span class="p">})</span>
  <span class="n">LidarVars_35c</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">LidarVars_Stat</span>
  <span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_Stat</span><span class="p">)</span>
  
  <span class="n">LidarVars_MultMtx</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">()</span>
  
  <span class="nf">for</span><span class="p">(</span><span class="n">ri</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">rngReps</span><span class="p">){</span>
    <span class="c1"># Random Dates for comparison</span>
    <span class="n">RandomDates</span> <span class="o">&lt;-</span> <span class="nf">seq</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2010-01-01 00:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                       <span class="n">to</span> <span class="o">=</span> <span class="nf">as.POSIXct</span><span class="p">(</span><span class="s">"2016-12-31 23:00:00"</span><span class="p">,</span><span class="n">tz</span> <span class="o">=</span> <span class="s">"UTC"</span><span class="p">),</span>
                       <span class="n">by</span><span class="o">=</span><span class="s">"hour"</span><span class="p">)</span> <span class="o">%&gt;%</span>
                   <span class="nf">sample</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">.</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="nf">length</span><span class="p">(</span><span class="n">Corr_absc532_d</span><span class="o">$</span><span class="n">DatesH</span><span class="p">),</span> <span class="n">replace</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">)</span>

    <span class="n">LidarVars_StatRNG</span> <span class="o">&lt;-</span> <span class="nf">lapply</span><span class="p">(</span><span class="n">LidarStations_35d</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span> <span class="nf">function</span><span class="p">(</span><span class="n">ldVar</span><span class="p">){</span>
                            <span class="n">ldVar</span><span class="p">[</span><span class="n">ldVar</span><span class="o">$</span><span class="n">DatesH</span> <span class="o">%in%</span> <span class="n">RandomDates</span><span class="p">,]</span> <span class="o">%&gt;%</span>
                            <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="s">"Dates"</span><span class="p">,</span><span class="s">"DatesH"</span><span class="p">,</span><span class="s">"DatesD"</span><span class="p">))</span> <span class="o">%&gt;%</span>
                            <span class="nf">as.matrix</span><span class="p">()</span>
                          <span class="p">})</span>
    <span class="n">LidarVars_MultMtx</span><span class="p">[[</span><span class="n">ri</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">LidarVars_StatRNG</span>
  <span class="p">}</span>
  
  <span class="c1"># Extract BAE matrices</span>
  <span class="n">LidarVars_BAE</span> <span class="o">&lt;-</span> <span class="nf">sapply</span><span class="p">(</span><span class="n">LidarVars_MultMtx</span><span class="p">,</span> <span class="s">"["</span><span class="p">,</span> <span class="s">"absc532"</span><span class="p">)</span>
  <span class="c1"># Compute the mean matrix for all random dates</span>
  <span class="n">LidarVars_mean</span> <span class="o">&lt;-</span> <span class="nf">rowMeans</span><span class="p">(</span><span class="nf">simplify2array</span><span class="p">(</span><span class="n">LidarVars_BAE</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="m">2</span><span class="p">,</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span>
  <span class="c1"># Store in a list per station</span>
  <span class="n">LidarVars_RNG</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="n">LidarVars_mean</span>
  <span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_mean</span><span class="p">)</span>
  <span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_MultMtx</span><span class="p">)</span>
  
  <span class="c1"># BAE(532/1064) height distribution list per station</span>
  <span class="n">BAE_list</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span>
    <span class="n">subWeekly_Mean</span> <span class="o">=</span> <span class="n">LidarVars_35c</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span><span class="o">$</span><span class="n">absc532</span> <span class="o">%&gt;%</span> 
                       <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">DatesH</span><span class="p">,</span> <span class="n">DatesD</span><span class="p">))</span> <span class="o">%&gt;%</span>
                       <span class="nf">as.matrix</span><span class="p">()</span> <span class="o">%&gt;%</span>
                       <span class="nf">colMeans</span><span class="p">(</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
   <span class="n">subWeekly_Upper</span> <span class="o">=</span> <span class="n">LidarVars_35c</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span><span class="o">$</span><span class="n">absc532</span> <span class="o">%&gt;%</span> 
                      <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">DatesH</span><span class="p">,</span> <span class="n">DatesD</span><span class="p">))</span> <span class="o">%&gt;%</span>
                      <span class="nf">as.matrix</span><span class="p">()</span> <span class="o">%&gt;%</span>
                      <span class="nf">apply</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">MARGIN</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">uh</span><span class="p">){</span>
                         <span class="n">output</span> <span class="o">&lt;-</span> <span class="nf">bsci</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
                         <span class="n">upperLim</span> <span class="o">&lt;-</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">.</span><span class="m">95</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
                         <span class="nf">return</span><span class="p">(</span><span class="n">upperLim</span><span class="p">)</span>
                      <span class="p">}),</span>
                    <span class="c1">#colMeans(na.rm=TRUE),</span>
   <span class="n">subWeekly_Lower</span> <span class="o">=</span> <span class="n">LidarVars_35c</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]]</span><span class="o">$</span><span class="n">absc532</span> <span class="o">%&gt;%</span> 
                      <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">DatesH</span><span class="p">,</span> <span class="n">DatesD</span><span class="p">))</span> <span class="o">%&gt;%</span>
                      <span class="nf">as.matrix</span><span class="p">()</span>  <span class="o">%&gt;%</span>
                      <span class="nf">apply</span><span class="p">(</span><span class="n">.</span><span class="p">,</span> <span class="n">MARGIN</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">ul</span><span class="p">){</span>
                        <span class="n">output</span> <span class="o">&lt;-</span> <span class="nf">bsci</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
                        <span class="n">lowerLim</span> <span class="o">&lt;-</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">.</span><span class="m">05</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
                        <span class="nf">return</span><span class="p">(</span><span class="n">lowerLim</span><span class="p">)</span>
                      <span class="p">}),</span>
   <span class="n">RNG_Mean</span>  <span class="o">=</span>  <span class="nf">colMeans</span><span class="p">(</span><span class="n">LidarVars_RNG</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span> <span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),</span>
   <span class="n">RNG_Upper</span>  <span class="o">=</span>  <span class="nf">apply</span><span class="p">(</span><span class="n">LidarVars_RNG</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span> <span class="n">MARGIN</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">uh</span><span class="p">){</span>
                     <span class="n">output</span> <span class="o">&lt;-</span> <span class="nf">bsci</span><span class="p">(</span><span class="n">uh</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
                     <span class="n">upperLim</span> <span class="o">&lt;-</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">.</span><span class="m">95</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
                   <span class="nf">return</span><span class="p">(</span><span class="n">upperLim</span><span class="p">)</span>
                 <span class="p">}),</span>
   <span class="n">RNG_Lower</span>  <span class="o">=</span>  <span class="nf">apply</span><span class="p">(</span><span class="n">LidarVars_RNG</span><span class="p">[[</span><span class="n">ldStat</span><span class="p">]],</span> <span class="n">MARGIN</span> <span class="o">=</span> <span class="m">2</span><span class="p">,</span> <span class="n">FUN</span><span class="o">=</span><span class="nf">function</span><span class="p">(</span><span class="n">ul</span><span class="p">){</span>
                     <span class="n">output</span> <span class="o">&lt;-</span> <span class="nf">bsci</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="m">100</span><span class="p">)</span>
                     <span class="n">upperLim</span> <span class="o">&lt;-</span> <span class="nf">quantile</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">.</span><span class="m">05</span><span class="p">,</span> <span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
                   <span class="nf">return</span><span class="p">(</span><span class="n">upperLim</span><span class="p">)</span>
                 <span class="p">}),</span>
   <span class="n">Station</span> <span class="o">=</span> <span class="nf">rep</span><span class="p">(</span><span class="n">ldStat</span><span class="p">,</span><span class="m">197</span><span class="p">),</span>
   <span class="n">Height</span> <span class="o">=</span> <span class="nf">seq</span><span class="p">(</span><span class="m">0.12</span><span class="p">,</span><span class="m">6</span><span class="p">,</span><span class="n">length.out</span> <span class="o">=</span> <span class="m">197</span><span class="p">)</span>
<span class="p">)</span>

<span class="p">}</span>
<span class="c1"># Remove memory heavy objects</span>

<span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_BAE</span><span class="p">)</span>
<span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_RNG</span><span class="p">)</span>
<span class="nf">remove</span><span class="p">(</span><span class="n">LidarVars_StatRNG</span><span class="p">)</span>


<span class="c1"># Bind lidar stations into a single dataset</span>
<span class="n">BAE</span> <span class="o">&lt;-</span> <span class="nf">bind_rows</span><span class="p">(</span><span class="n">BAE_list</span><span class="p">,</span><span class="n">.id</span> <span class="o">=</span> <span class="s">"BindVar"</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">select</span><span class="p">(</span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">BindVar</span><span class="p">))</span>

<span class="c1"># Format for ggplot input</span>
<span class="n">BAE_gg</span> <span class="o">&lt;-</span> <span class="nf">melt</span><span class="p">(</span><span class="n">BAE</span><span class="p">,</span> <span class="n">id.vars</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"Height"</span><span class="p">,</span><span class="s">"Station"</span><span class="p">),</span> <span class="n">variable.name</span> <span class="o">=</span> <span class="s">"Dates"</span><span class="p">)</span> <span class="o">%&gt;%</span>
          <span class="c1"># For absc532 and 1064</span>
          <span class="nf">mutate</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">*</span><span class="m">1E06</span><span class="p">)</span>

<span class="n">BAE_gg</span><span class="o">$</span><span class="n">Stationf</span> <span class="o">&lt;-</span> <span class="nf">factor</span><span class="p">(</span><span class="n">BAE_gg</span><span class="o">$</span><span class="n">Station</span><span class="p">,</span> <span class="n">levels</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"TYM"</span><span class="p">,</span><span class="s">"TKB"</span><span class="p">,</span><span class="s">"TKO"</span><span class="p">))</span>


<span class="c1"># Colours for plot</span>
<span class="n">my_colors</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">"seagreen1"</span><span class="p">,</span><span class="s">"seagreen4"</span><span class="p">,</span><span class="s">"seagreen1"</span><span class="p">,</span><span class="s">"orangered1"</span><span class="p">,</span> <span class="s">"orangered4"</span><span class="p">,</span> <span class="s">"orangered1"</span><span class="p">)</span>
<span class="nf">names</span><span class="p">(</span><span class="n">my_colors</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">levels</span><span class="p">(</span><span class="nf">factor</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="nf">levels</span><span class="p">(</span><span class="n">BAE_gg</span><span class="o">$</span><span class="n">Dates</span><span class="p">),</span> <span class="nf">levels</span><span class="p">(</span><span class="n">BAE_gg</span><span class="o">$</span><span class="n">Dates</span><span class="p">))))</span>
<span class="c1"># Spread variables to inout geo_ribbon and shade the area between curves</span>
<span class="n">BAE_gg_Area</span> <span class="o">&lt;-</span> <span class="n">BAE_gg</span> <span class="o">%&gt;%</span> <span class="nf">spread</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="c1">#Plot Vertical profiles with 96% interval confidence for </span>
<span class="c1">#3 lidar stations and one lidar variable</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">BAE_gg</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">Height</span><span class="p">,</span><span class="n">value</span><span class="p">))</span> <span class="o">+</span> 
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="n">Dates</span> <span class="p">))</span> <span class="o">+</span>
  <span class="nf">scale_color_manual</span><span class="p">(</span><span class="n">values</span> <span class="o">=</span> <span class="n">my_colors</span><span class="p">,</span>
                     <span class="n">name</span>  <span class="o">=</span><span class="s">"Dates"</span><span class="p">,</span>
                     <span class="n">breaks</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">"subWeekly_Mean"</span><span class="p">,</span> <span class="s">"RNG_Mean"</span><span class="p">),</span>
                     <span class="n">labels</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s">"3.5 days\ncycle"</span><span class="p">,</span> <span class="s">"Random"</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">BAE_gg_Area</span><span class="p">,</span> <span class="n">inherit.aes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span>
              <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Height</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">RNG_Lower</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">RNG_Upper</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">"seagreen1"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_ribbon</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">BAE_gg_Area</span><span class="p">,</span> <span class="n">inherit.aes</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span>
              <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Height</span><span class="p">,</span><span class="n">ymin</span><span class="o">=</span><span class="n">subWeekly_Lower</span><span class="p">,</span><span class="n">ymax</span><span class="o">=</span><span class="n">subWeekly_Upper</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="m">0.3</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s">"orangered1"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">"absc532 [/Mm/sr]"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">xlab</span><span class="p">(</span><span class="s">"Altitude [km]"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">coord_cartesian</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">7</span><span class="p">))</span> <span class="o">+</span>
  <span class="c1">#scale_y_continuous(breaks = round(seq(1,6, by = 1),1)) +</span>
  <span class="nf">coord_flip</span><span class="p">()</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
    <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
    <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  <span class="c1">#geom_hline(yintercept=1,linetype="dashed") +</span>
  <span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="m">4.3</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="s">"dashed"</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"orange"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_vline</span><span class="p">(</span><span class="n">xintercept</span><span class="o">=</span><span class="m">0.6</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="s">"dashed"</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"royalblue3"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_hline</span><span class="p">(</span><span class="n">yintercept</span><span class="o">=</span><span class="m">0.1</span><span class="p">,</span><span class="n">linetype</span><span class="o">=</span><span class="s">"dashed"</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s">"lightsteelblue"</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ylim</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">6</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">facet_wrap</span><span class="p">(</span><span class="o">~</span><span class="n">Stationf</span><span class="p">)</span>
<span class="c1"># width = 800 height 700</span>
<span class="nf">grid.text</span><span class="p">(</span><span class="s">"Confidence\ninterval 0.95\n\nTotal\nDateTimes:\nTKB: 7914\nTKO: 7384\nTYM: 3868"</span><span class="p">,</span>
          <span class="n">x</span><span class="o">=</span><span class="nf">unit</span><span class="p">(</span><span class="m">0.85</span><span class="p">,</span><span class="s">"npc"</span><span class="p">),</span><span class="n">y</span><span class="o">=</span><span class="nf">unit</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="s">"npc"</span><span class="p">),</span><span class="n">just</span> <span class="o">=</span> <span class="s">"left"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Coordinate system already present. Adding new coordinate system, which will replace the existing one.
</pre></div>
</div>
<img alt="_images/weekly-cycle-figures-ang_19_1.png" src="_images/weekly-cycle-figures-ang_19_1.png"/>
</div>
</div>
</div>
</div>
<div class="section" id="supplementary-figure-8">
<h2>Supplementary Figure 8<a class="headerlink" href="#supplementary-figure-8" title="Permalink to this headline">Â¶</a></h2>
</div>
<div class="section" id="supplementary-figure-9">
<h2>Supplementary Figure 9<a class="headerlink" href="#supplementary-figure-9" title="Permalink to this headline">Â¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">install.packages</span><span class="p">(</span><span class="s">"ggpubr"</span><span class="p">,</span>
                 <span class="n">repos</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">"https://cran.rediris.org/"</span><span class="p">,</span> <span class="s">"https://cloud.r-project.org/"</span><span class="p">),</span>
                 <span class="n">dependencies</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>
<span class="nf">require</span><span class="p">(</span><span class="s">"ggpubr"</span><span class="p">,</span><span class="n">character.only</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> <span class="n">quietly</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span>

<span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">5</span><span class="p">,</span> <span class="n">repr.plot.res</span><span class="o">=</span><span class="m">300</span><span class="p">)</span>

<span class="n">KD_file_ms</span> <span class="o">&lt;-</span> <span class="nf">read_csv</span><span class="p">(</span><span class="s">"../data/KD_1970_2016_Albert.csv"</span><span class="p">,</span> <span class="n">col_types</span> <span class="o">=</span> <span class="nf">cols</span><span class="p">(</span><span class="n">.default</span> <span class="o">=</span> <span class="s">"c"</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">mutate</span><span class="p">(</span><span class="n">Dates</span><span class="o">=</span><span class="nf">as.Date</span><span class="p">(</span><span class="n">Dates</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">rename</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">"KD_TKB"</span><span class="o">=</span><span class="s">"8"</span><span class="p">,</span> <span class="s">"KD_TKO"</span><span class="o">=</span><span class="s">"13"</span><span class="p">,</span> <span class="s">"KD_TYM"</span><span class="o">=</span><span class="s">"16"</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">mutate</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="o">!</span><span class="n">Dates</span><span class="p">,</span> <span class="n">as.numeric</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="n">.</span><span class="p">[</span><span class="n">.</span><span class="o">$</span><span class="n">Dates</span> <span class="o">%in%</span> <span class="nf">seq</span><span class="p">(</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2010-01-05"</span><span class="p">),</span><span class="nf">as.Date</span><span class="p">(</span><span class="s">"2016-12-25"</span><span class="p">),</span><span class="n">by</span><span class="o">=</span><span class="s">"day"</span><span class="p">),]</span> <span class="o">%&gt;%</span>
              <span class="nf">mutate</span><span class="p">(</span><span class="n">Month</span><span class="o">=</span><span class="nf">month</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">group_by</span><span class="p">(</span><span class="n">Month</span><span class="p">)</span> <span class="o">%&gt;%</span>
              <span class="nf">summarize_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="s">"KD_TKB"</span><span class="p">,</span> <span class="s">"KD_TKO"</span><span class="p">,</span> <span class="s">"KD_TYM"</span><span class="p">),</span> <span class="nf">list</span><span class="p">(</span><span class="o">~</span><span class="nf">sum</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span>  <span class="p">)</span>

<span class="n">Corr_tb_TKO_ms</span> <span class="o">&lt;-</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">Dates</span> <span class="o">=</span> <span class="nf">as.Date</span><span class="p">(</span> <span class="nf">names</span><span class="p">(</span> <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TKB"</span><span class="p">]])</span> <span class="p">),</span>
                         <span class="n">Corr_TKB</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TKB"</span><span class="p">]],</span>
                         <span class="n">Corr_TKO</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TKO"</span><span class="p">]],</span>
                         <span class="n">Corr_TYM</span> <span class="o">=</span>  <span class="n">Corr_tw84_c</span><span class="p">[[</span><span class="s">"TYM"</span><span class="p">]],</span>
                        <span class="p">)</span> <span class="o">%&gt;%</span>
              <span class="nf">mutate</span><span class="p">(</span><span class="n">Month</span><span class="o">=</span><span class="nf">month</span><span class="p">(</span><span class="n">Dates</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span> <span class="o">%&gt;%</span>
              <span class="nf">group_by</span><span class="p">(</span><span class="n">Month</span><span class="p">)</span> <span class="o">%&gt;%</span>
              <span class="nf">summarize_at</span><span class="p">(</span><span class="nf">vars</span><span class="p">(</span><span class="s">"Corr_TKB"</span><span class="p">,</span> <span class="s">"Corr_TKO"</span><span class="p">,</span> <span class="s">"Corr_TYM"</span><span class="p">),</span> <span class="nf">list</span><span class="p">(</span><span class="o">~</span><span class="nf">sum</span><span class="p">(</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">.</span><span class="p">),</span><span class="n">na.rm</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">))</span> <span class="p">)</span>
<span class="n">KD_2010_16_ms_gg</span> <span class="o">&lt;-</span> <span class="nf">right_join</span><span class="p">(</span><span class="n">Corr_tb_TKO_ms</span><span class="p">,</span> <span class="n">KD_file_ms</span><span class="p">,</span><span class="n">by</span> <span class="o">=</span> <span class="s">"Month"</span><span class="p">)</span>

<span class="n">ms_scale</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">){</span> 
    <span class="n">ms</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))}</span>
<span class="n">is_scale</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">){</span> 
    <span class="n">is</span> <span class="o">&lt;-</span> <span class="nf">min</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">-</span> <span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="o">*</span><span class="p">(</span>
        <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">na.rm</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">))</span>
    <span class="p">)}</span>

<span class="n">mTKO_ms</span> <span class="o">&lt;-</span> <span class="nf">ms_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TKO</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TKO</span><span class="p">)</span>
<span class="n">iTKO_ms</span> <span class="o">&lt;-</span> <span class="nf">is_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TKO</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TKO</span><span class="p">)</span> <span class="o">+</span> <span class="m">500</span> <span class="c1"># Needs extra help to plot</span>
<span class="n">TKO_gg</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">KD_2010_16_ms_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Month</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KD_TKO</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">Corr_TKO</span><span class="o">-</span><span class="n">iTKO_ms</span><span class="p">)</span><span class="o">/</span><span class="n">mTKO_ms</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">),</span> 
              <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">mTKO_ms</span><span class="o">+</span> <span class="n">iTKO_ms</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">""</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'Time [month]'</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"dodgerblue"</span><span class="p">),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span><span class="p">,</span>
          <span class="n">plot.margin</span> <span class="o">=</span> <span class="nf">margin</span><span class="p">(</span><span class="m">-40</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
          <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
            <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
            <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
          <span class="p">)</span>
    
    
    

<span class="n">mTKB_ms</span> <span class="o">&lt;-</span> <span class="nf">ms_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TKB</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TKB</span><span class="p">)</span>
<span class="n">iTKB_ms</span> <span class="o">&lt;-</span> <span class="nf">is_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TKB</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TKB</span><span class="p">)</span> 
<span class="n">TKB_gg</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">KD_2010_16_ms_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Month</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KD_TKB</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">Corr_TKB</span><span class="o">-</span><span class="n">iTKB_ms</span><span class="p">)</span><span class="o">/</span><span class="n">mTKB_ms</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">),</span> 
              <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">mTKB_ms</span><span class="o">+</span> <span class="n">iTKB_ms</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">"PM arrival SWC"</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">'KD cases'</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"dodgerblue"</span><span class="p">),</span>
          <span class="n">axis.text.x</span><span class="o">=</span><span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span><span class="p">,</span>
          <span class="n">plot.margin</span> <span class="o">=</span> <span class="nf">margin</span><span class="p">(</span><span class="m">-30</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">6</span><span class="p">),</span>
          <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
            <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
            <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
          <span class="p">)</span>
    

<span class="n">mTYM_ms</span> <span class="o">&lt;-</span> <span class="nf">ms_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TYM</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TYM</span><span class="p">)</span>
<span class="n">iTYM_ms</span> <span class="o">&lt;-</span> <span class="nf">is_scale</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">KD_TYM</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="n">KD_2010_16_ms_gg</span><span class="o">$</span><span class="n">Corr_TYM</span><span class="p">)</span> 
<span class="n">TYM_gg</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">KD_2010_16_ms_gg</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Month</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="n">KD_TYM</span><span class="p">),</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">geom_line</span><span class="p">(</span> <span class="nf">aes</span><span class="p">(</span><span class="n">y</span><span class="o">=</span> <span class="p">(</span><span class="n">Corr_TYM</span><span class="o">-</span><span class="n">iTYM_ms</span><span class="p">)</span><span class="o">/</span><span class="n">mTYM_ms</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="m">1</span><span class="p">),</span> 
              <span class="n">color</span><span class="o">=</span><span class="s">"dodgerblue"</span><span class="p">)</span> <span class="o">+</span>
    <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">sec.axis</span> <span class="o">=</span> <span class="nf">sec_axis</span><span class="p">(</span><span class="n">trans</span><span class="o">=~</span><span class="n">.</span><span class="o">*</span><span class="n">mTYM_ms</span><span class="o">+</span> <span class="n">iTYM_ms</span><span class="p">,</span> <span class="c1">#trans_sec , #* ggCoeff_weekly,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s">""</span><span class="p">))</span> <span class="o">+</span>
    <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span> 
    <span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">y</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
         <span class="n">subtitle</span><span class="o">=</span><span class="nf">paste</span><span class="p">(</span><span class="s">''</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">'\n'</span><span class="p">),</span>
         <span class="n">color</span><span class="o">=</span><span class="s">'Variable'</span><span class="p">)</span> <span class="o">+</span> 
    <span class="nf">theme</span><span class="p">(</span><span class="n">plot.subtitle</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"#605e5e"</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="m">9</span><span class="p">),</span>
          <span class="n">plot.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">12</span><span class="p">),</span>
          <span class="n">axis.title.y.right</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="s">"dodgerblue"</span><span class="p">),</span>
          <span class="n">axis.text.x</span><span class="o">=</span><span class="nf">element_blank</span><span class="p">(),</span>
          <span class="n">legend.position</span><span class="o">=</span><span class="s">"none"</span><span class="p">,</span>
          <span class="n">plot.margin</span> <span class="o">=</span> <span class="nf">margin</span><span class="p">(</span><span class="m">-20</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">-10</span><span class="p">,</span> <span class="m">6</span><span class="p">),</span>
          <span class="n">text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="m">15</span><span class="p">),</span>
            <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span>
            <span class="n">panel.border</span> <span class="o">=</span> <span class="nf">element_rect</span><span class="p">(</span><span class="n">colour</span><span class="o">=</span><span class="s">"black"</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">NA</span><span class="p">)</span>
          <span class="p">)</span>
    
    

<span class="nf">ggarrange</span><span class="p">(</span><span class="n">TYM_gg</span><span class="p">,</span> <span class="n">TKB_gg</span><span class="p">,</span> <span class="n">TKO_gg</span><span class="p">,</span> 
                    <span class="c1">#labels = c("A", "B", "C"),</span>
                    <span class="n">ncol</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Installing package into â€˜/home/navarral/R/x86_64-pc-linux-gnu-library/3.6â€™
(as â€˜libâ€™ is unspecified)
</pre></div>
</div>
<img alt="_images/weekly-cycle-figures-ang_23_1.png" src="_images/weekly-cycle-figures-ang_23_1.png"/>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class="prev-next-area"> 
    <a class="left-prev" href="metals.html" id="prev-link" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Metals in air masses and their effect on KD onset</p>
        </div>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Alejandro Fontal, Albert Navarro, Xavier RodÃ³<br/>
    
        Â© Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  
</body></html>